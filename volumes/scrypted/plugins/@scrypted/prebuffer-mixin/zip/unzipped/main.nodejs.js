(()=>{var e={5948:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseWWWAuthenticateHeader=function(e,t=c,{strict:r=!0}={strict:!0}){let s=null;if(t.some((t=>(0===e.indexOf(t.type+" ")||!r&&0===e.indexOf(t.type.toLowerCase()+" "))&&(s={type:t.type,data:t.parseWWWAuthenticateRest(e.substr(t.type.length+1))},!0))),!s)throw new i.default("E_UNKNOWN_AUTH_MECHANISM",e);return s},t.parseAuthorizationHeader=function(e,t=c,{strict:r=!0}={strict:!0}){let s=null;if(t.some((function(t){return(0===e.indexOf(t.type+" ")||!r&&0===e.indexOf(t.type.toLowerCase()+" "))&&(s={type:t.type,data:t.parseAuthorizationRest(e.substr(t.type.length+1))},!0)})),s)return s;throw new i.default("E_UNKNOWN_AUTH_MECHANISM",e)},t.buildWWWAuthenticateHeader=function(e,t){return`${e.type} ${e.buildWWWAuthenticateRest(t)}`},t.buildAuthorizationHeader=function(e,t){return`${e.type} ${e.buildAuthorizationRest(t)}`},Object.defineProperty(t,"BASIC",{enumerable:!0,get:function(){return s.default}}),Object.defineProperty(t,"DIGEST",{enumerable:!0,get:function(){return n.default}}),Object.defineProperty(t,"BEARER",{enumerable:!0,get:function(){return o.default}}),t.mechanisms=void 0;var i=a(r(8257)),s=a(r(6750)),n=a(r(3107)),o=a(r(736));function a(e){return e&&e.__esModule?e:{default:e}}const c=[s.default,n.default,o.default];t.mechanisms=c,s.default,n.default,o.default},6750:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i,s=(i=r(8257))&&i.__esModule?i:{default:i},n=r(9358);const o=["realm"],a=o,c={type:"Basic",parseWWWAuthenticateRest:function(e){return(0,n.parseHTTPHeadersQuotedKeyValueSet)(e,a,o)},buildWWWAuthenticateRest:function(e){return(0,n.buildHTTPHeadersQuotedKeyValueSet)(e,a,o)},parseAuthorizationRest:function(e){if(!e)throw new s.default("E_EMPTY_AUTH");const{username:t,password:r}=c.decodeHash(e);return{hash:e,username:t,password:r}},buildAuthorizationRest:function({hash:e,username:t,password:r}){if(t&&r)return c.computeHash({username:t,password:r});if(!e)throw new s.default("E_NO_HASH");return e},computeHash:function({username:e,password:t}){return Buffer.from(e+":"+t).toString("base64")},decodeHash:function(e){const[t,...r]=Buffer.from(e,"base64").toString().split(":");return{username:t,password:r.join(":")}}};var l=c;t.default=l},736:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i,s=(i=r(8257))&&i.__esModule?i:{default:i},n=r(9358);const o=["invalid_request","invalid_token","insufficient_scope"],a=["realm","scope","error","error_description"];var c={type:"Bearer",parseWWWAuthenticateRest:function(e){return(0,n.parseHTTPHeadersQuotedKeyValueSet)(e,a,[])},buildWWWAuthenticateRest:function(e){if(e.error&&-1===o.indexOf(e.error))throw new s.default("E_INVALID_ERROR",e.error,o);return(0,n.buildHTTPHeadersQuotedKeyValueSet)(e,a,[])},parseAuthorizationRest:function(e){if(!e)throw new s.default("E_EMPTY_AUTH");return{hash:e}},buildAuthorizationRest:function({hash:e}){if(!e)throw new s.default("E_NO_HASH");return e}};t.default=c},3107:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i,s=r(9358),n=(i=r(6113))&&i.__esModule?i:{default:i};const o=["realm","nonce"],a=[...o,"domain","opaque","stale","algorithm","qop"],c=["username","realm","nonce","uri","response"],l=[...c,"algorithm","cnonce","opaque","qop","nc"];function d(e,t){const r=n.default.createHash(e);return r.update(t),r.digest("hex")}var u={type:"Digest",parseWWWAuthenticateRest:function(e){return(0,s.parseHTTPHeadersQuotedKeyValueSet)(e,a,o)},buildWWWAuthenticateRest:function(e){return(0,s.buildHTTPHeadersQuotedKeyValueSet)(e,a,o)},parseAuthorizationRest:function(e){return(0,s.parseHTTPHeadersQuotedKeyValueSet)(e,l,c)},buildAuthorizationRest:function(e){return(0,s.buildHTTPHeadersQuotedKeyValueSet)(e,l,c)},computeHash:function(e){const t=e.ha1||d(e.algorithm,[e.username,e.realm,e.password].join(":")),r=d(e.algorithm,[e.method,e.uri].join(":"));return d(e.algorithm,[t,e.nonce,e.nc,e.cnonce,e.qop,r].join(":"))}};t.default=u},9358:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseHTTPHeadersQuotedKeyValueSet=function(e,t,r=[]){const i=e.trim().match(n);if(!i)throw new s.default("E_MALFORMED_QUOTEDKEYVALUE",e);const a=i.map(((e,t)=>{const r=e.split("=");if(2!==r.length)throw new s.default("E_MALFORMED_QUOTEDKEYVALUE",t,e,r.length);return r})).reduce((function(e,[r,i],n){if(-1===t.indexOf(r))throw new s.default("E_UNAUTHORIZED_KEY",n,r);return e[r]=i.replace(/^"(.+(?="$))"$/,"$1"),e}),{});return o(r,a),a},t.buildHTTPHeadersQuotedKeyValueSet=function(e,t,r=[]){return o(r,e),t.reduce((function(t,r){return e[r]?t+(t?", ":"")+r+'="'+e[r]+'"':t}),"")};var i,s=(i=r(8257))&&i.__esModule?i:{default:i};const n=/\w+=(".*?"|[^",]+)(?=,|$)/g;function o(e,t){e.forEach((e=>{if(void 0===t[e])throw new s.default("E_REQUIRED_KEY",e)}))}},309:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Bitstream=class{constructor(e){this.view=e,this.bitoffset=0}ExpGolomb(){const{view:e}=this;let{zeros:t,skip:r,byt:i,byteoffset:s}=function(e,t){let r=0,i=t>>3,s=7&t,n=-1,o=e.getUint8(i)<<s;do{r=128&o,o<<=1,n++,s++,8===s&&(s=0,i++,o=e.getUint8(i))}while(!r);return{zeros:n,skip:s,byt:o,byteoffset:i}}(e,this.bitoffset),n=1;for(;t>0;)n=n<<1|(128&i)>>>7,i<<=1,r++,t--,8===r&&(r=0,s++,i=e.getUint8(s));return this.bitoffset=s<<3|r,n-1}SignedExpGolomb(){const e=this.ExpGolomb();return 1&e?e+1>>>1:-(e>>>1)}readBit(){const e=7&this.bitoffset,t=this.bitoffset>>3;return this.bitoffset++,this.view.getUint8(t)>>>7-e&1}readByte(){const e=7&this.bitoffset,t=this.bitoffset>>>3;this.bitoffset+=8;const r=this.view.getUint8(t);if(0===e)return r;return r<<e|this.view.getUint8(t+1)>>>8-e}readNibble(){const e=7&this.bitoffset,t=this.bitoffset>>3;this.bitoffset+=4;const r=this.view.getUint8(t);if(0===e)return r>>>4;if(e<=4)return r>>>4-e&15;return 15&(r<<e-4|this.view.getUint8(t+1)>>>12-e)}read5(){const e=7&this.bitoffset,t=this.bitoffset>>3;this.bitoffset+=5;const r=this.view.getUint8(t);if(0===e)return r>>>3;if(e<=3)return r>>>3-e&31;return 31&(r<<e-3|this.view.getUint8(t+1)>>>11-e)}readWord(){const e=7&this.bitoffset,t=this.bitoffset>>>3;this.bitoffset+=32;const{view:r}=this,i=65536*r.getUint16(t)+r.getUint16(t+2);return 0===e?i:i*2**e+(r.getUint8(t+4)>>>8-e)}more_rbsp_data(){const e=7&this.bitoffset;let t=this.bitoffset>>3;const r=this.view.byteLength;if(t>=r)return!1;let i=this.view.getUint8(t)<<e&255,s=i>0;if(s&&!Number.isInteger(Math.log2(i)))return!0;for(;++t<r;){i=this.view.getUint8(t);const e=i>0;if(s&&e)return!0;if(e&&!Number.isInteger(Math.log2(i)))return!0;s=s||e}return!1}}},3859:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=r(309);t.Bitstream=i.Bitstream;const s=r(7892);function n(e,t,r,i){let s=8,n=8;const o=[];for(let a=0;a<t;a++){if(0!==n){n=(s+e.SignedExpGolomb()+256)%256,r[i]=+(0===a&&0===n)}n&&(s=n),o[a]=s}return o}t.parse=function(e){if(7!=(31&e[0]))throw new Error("Not an SPS unit");const t=new i.Bitstream(new DataView(e.buffer,e.byteOffset+4)),r=e[1],o=e[2],a=e[3],c=t.ExpGolomb();let l=1,d=0,u=0,p=0,h=0,m=0;const f=[],g=[],v=[],S=[];if(100===r||110===r||122===r||244===r||44===r||83===r||86===r||118===r||128===r||138===r||139===r||134===r||135===r){l=t.ExpGolomb();let e=8;if(3===l&&(e=12,p=t.readBit()),d=t.ExpGolomb()+8,u=t.ExpGolomb()+8,h=t.readBit(),m=t.readBit(),m){let r=0;for(;r<6;r++)t.readBit()&&f.push(n(t,16,v,r));for(;r<e;r++)t.readBit()&&g.push(n(t,64,S,r-6))}}const y=t.ExpGolomb()+4,_=t.ExpGolomb();let b=0,w=0,E=0;const P=[];let T=0;if(0===_)T=t.ExpGolomb()+4;else if(1===_){b=t.readBit(),w=t.SignedExpGolomb(),E=t.SignedExpGolomb();const e=t.ExpGolomb();for(let r=0;r<e;r++)P.push(t.SignedExpGolomb())}const R=t.ExpGolomb(),I=t.readBit(),O=t.ExpGolomb()+1,A=t.ExpGolomb()+1,M=t.readBit();let x=0;M||(x=t.readBit());const D=t.readBit(),C=t.readBit(),N=function(e,t){return e?{left:t.ExpGolomb(),right:t.ExpGolomb(),top:t.ExpGolomb(),bottom:t.ExpGolomb()}:{left:0,right:0,top:0,bottom:0}}(C,t),L=t.readBit();return{sps_id:c,profile_compatibility:o,profile_idc:r,level_idc:a,chroma_format_idc:l,bit_depth_luma:d,bit_depth_chroma:u,color_plane_flag:p,qpprime_y_zero_transform_bypass_flag:h,seq_scaling_matrix_present_flag:m,seq_scaling_matrix:f,log2_max_frame_num:y,pic_order_cnt_type:_,delta_pic_order_always_zero_flag:b,offset_for_non_ref_pic:w,offset_for_top_to_bottom_field:E,offset_for_ref_frame:P,log2_max_pic_order_cnt_lsb:T,max_num_ref_frames:R,gaps_in_frame_num_value_allowed_flag:I,pic_width_in_mbs:O,pic_height_in_map_units:A,frame_mbs_only_flag:M,mb_adaptive_frame_field_flag:x,direct_8x8_inference_flag:D,frame_cropping_flag:C,frame_cropping:N,vui_parameters_present_flag:L,vui_parameters:s.getVUIParams(L,t)}}},7892:(e,t)=>{"use strict";function r(e,t){const r=t.ExpGolomb();e.cpb_cnt=r+1,e.bit_rate_scale=t.readNibble(),e.cpb_size_scale=t.readNibble();for(let i=0;i<=r;i++)e.bit_rate_value[i]=t.ExpGolomb()+1,e.cpb_size_value[i]=t.ExpGolomb()+1,e.cbr_flag[i]=t.readBit();e.initial_cpb_removal_delay_length=t.read5()+1,e.cpb_removal_delay_length=t.read5()+1,e.dpb_output_delay_length=t.read5()+1,e.time_offset_length=t.read5()}Object.defineProperty(t,"__esModule",{value:!0}),t.getVUIParams=function(e,t){const i={aspect_ratio_info_present_flag:0,aspect_ratio_idc:0,sar_width:0,sar_height:0,overscan_info_present_flag:0,overscan_appropriate_flag:0,video_signal_type_present_flag:0,video_format:0,video_full_range_flag:0,colour_description_present_flag:0,colour_primaries:0,transfer_characteristics:0,matrix_coefficients:0,chroma_loc_info_present_flag:0,chroma_sample_loc_type_top_field:0,chroma_sample_loc_type_bottom_field:0,timing_info_present_flag:0,num_units_in_tick:0,time_scale:0,fixed_frame_rate_flag:0,nal_hrd_parameters_present_flag:0,vcl_hrd_parameters_present_flag:0,hrd_params:{cpb_cnt:0,bit_rate_scale:0,cpb_size_scale:0,bit_rate_value:[],cpb_size_value:[],cbr_flag:[],initial_cpb_removal_delay_length:0,cpb_removal_delay_length:0,dpb_output_delay_length:0,time_offset_length:0},low_delay_hrd_flag:0,pic_struct_present_flag:0,bitstream_restriction_flag:0,motion_vectors_over_pic_boundaries_flag:0,max_bytes_per_pic_denom:0,max_bits_per_mb_denom:0,log2_max_mv_length_horizontal:0,log2_max_mv_length_vertical:0,num_reorder_frames:0,max_dec_frame_buffering:0};return e?(i.aspect_ratio_info_present_flag=t.readBit(),i.aspect_ratio_info_present_flag&&(i.aspect_ratio_idc=t.ExpGolomb(),255===i.aspect_ratio_idc&&(i.sar_width=t.readByte(),i.sar_height=t.readByte())),i.overscan_info_present_flag=t.readBit(),i.overscan_info_present_flag&&(i.overscan_appropriate_flag=t.readBit()),i.video_signal_type_present_flag=t.readBit(),i.video_signal_type_present_flag&&(i.video_format=t.readBit()<<2|t.readBit()<<1|t.readBit(),i.video_full_range_flag=t.readBit(),i.colour_description_present_flag=t.readBit(),i.colour_description_present_flag&&(i.colour_primaries=t.readByte(),i.transfer_characteristics=t.readByte(),i.matrix_coefficients=t.readByte())),i.chroma_loc_info_present_flag=t.readBit(),i.chroma_loc_info_present_flag&&(i.chroma_sample_loc_type_top_field=t.ExpGolomb(),i.chroma_sample_loc_type_bottom_field=t.ExpGolomb()),i.timing_info_present_flag=t.readBit(),i.timing_info_present_flag&&(i.num_units_in_tick=t.readWord(),i.time_scale=t.readWord(),i.fixed_frame_rate_flag=t.readBit()),i.nal_hrd_parameters_present_flag=t.readBit(),i.nal_hrd_parameters_present_flag&&r(i.hrd_params,t),i.vcl_hrd_parameters_present_flag=t.readBit(),i.vcl_hrd_parameters_present_flag&&r(i.hrd_params,t),(i.nal_hrd_parameters_present_flag||i.vcl_hrd_parameters_present_flag)&&(i.low_delay_hrd_flag=t.readBit()),i.pic_struct_present_flag=t.readBit(),i.bitstream_restriction_flag=t.readBit(),i.bitstream_restriction_flag&&(i.motion_vectors_over_pic_boundaries_flag=t.readBit(),i.max_bytes_per_pic_denom=t.ExpGolomb(),i.max_bits_per_mb_denom=t.ExpGolomb(),i.log2_max_mv_length_horizontal=t.ExpGolomb(),i.log2_max_mv_length_vertical=t.ExpGolomb(),i.num_reorder_frames=t.ExpGolomb(),i.max_dec_frame_buffering=t.ExpGolomb()),i):i}},9593:(e,t,r)=>{"use strict";const i=r(4411),s=Symbol("max"),n=Symbol("length"),o=Symbol("lengthCalculator"),a=Symbol("allowStale"),c=Symbol("maxAge"),l=Symbol("dispose"),d=Symbol("noDisposeOnSet"),u=Symbol("lruList"),p=Symbol("cache"),h=Symbol("updateAgeOnGet"),m=()=>1;const f=(e,t,r)=>{const i=e[p].get(t);if(i){const t=i.value;if(g(e,t)){if(S(e,i),!e[a])return}else r&&(e[h]&&(i.value.now=Date.now()),e[u].unshiftNode(i));return t.value}},g=(e,t)=>{if(!t||!t.maxAge&&!e[c])return!1;const r=Date.now()-t.now;return t.maxAge?r>t.maxAge:e[c]&&r>e[c]},v=e=>{if(e[n]>e[s])for(let t=e[u].tail;e[n]>e[s]&&null!==t;){const r=t.prev;S(e,t),t=r}},S=(e,t)=>{if(t){const r=t.value;e[l]&&e[l](r.key,r.value),e[n]-=r.length,e[p].delete(r.key),e[u].removeNode(t)}};class y{constructor(e,t,r,i,s){this.key=e,this.value=t,this.length=r,this.now=i,this.maxAge=s||0}}const _=(e,t,r,i)=>{let s=r.value;g(e,s)&&(S(e,r),e[a]||(s=void 0)),s&&t.call(i,s.value,s.key,e)};e.exports=class{constructor(e){if("number"==typeof e&&(e={max:e}),e||(e={}),e.max&&("number"!=typeof e.max||e.max<0))throw new TypeError("max must be a non-negative number");this[s]=e.max||1/0;const t=e.length||m;if(this[o]="function"!=typeof t?m:t,this[a]=e.stale||!1,e.maxAge&&"number"!=typeof e.maxAge)throw new TypeError("maxAge must be a number");this[c]=e.maxAge||0,this[l]=e.dispose,this[d]=e.noDisposeOnSet||!1,this[h]=e.updateAgeOnGet||!1,this.reset()}set max(e){if("number"!=typeof e||e<0)throw new TypeError("max must be a non-negative number");this[s]=e||1/0,v(this)}get max(){return this[s]}set allowStale(e){this[a]=!!e}get allowStale(){return this[a]}set maxAge(e){if("number"!=typeof e)throw new TypeError("maxAge must be a non-negative number");this[c]=e,v(this)}get maxAge(){return this[c]}set lengthCalculator(e){"function"!=typeof e&&(e=m),e!==this[o]&&(this[o]=e,this[n]=0,this[u].forEach((e=>{e.length=this[o](e.value,e.key),this[n]+=e.length}))),v(this)}get lengthCalculator(){return this[o]}get length(){return this[n]}get itemCount(){return this[u].length}rforEach(e,t){t=t||this;for(let r=this[u].tail;null!==r;){const i=r.prev;_(this,e,r,t),r=i}}forEach(e,t){t=t||this;for(let r=this[u].head;null!==r;){const i=r.next;_(this,e,r,t),r=i}}keys(){return this[u].toArray().map((e=>e.key))}values(){return this[u].toArray().map((e=>e.value))}reset(){this[l]&&this[u]&&this[u].length&&this[u].forEach((e=>this[l](e.key,e.value))),this[p]=new Map,this[u]=new i,this[n]=0}dump(){return this[u].map((e=>!g(this,e)&&{k:e.key,v:e.value,e:e.now+(e.maxAge||0)})).toArray().filter((e=>e))}dumpLru(){return this[u]}set(e,t,r){if((r=r||this[c])&&"number"!=typeof r)throw new TypeError("maxAge must be a number");const i=r?Date.now():0,a=this[o](t,e);if(this[p].has(e)){if(a>this[s])return S(this,this[p].get(e)),!1;const o=this[p].get(e).value;return this[l]&&(this[d]||this[l](e,o.value)),o.now=i,o.maxAge=r,o.value=t,this[n]+=a-o.length,o.length=a,this.get(e),v(this),!0}const h=new y(e,t,a,i,r);return h.length>this[s]?(this[l]&&this[l](e,t),!1):(this[n]+=h.length,this[u].unshift(h),this[p].set(e,this[u].head),v(this),!0)}has(e){if(!this[p].has(e))return!1;const t=this[p].get(e).value;return!g(this,t)}get(e){return f(this,e,!0)}peek(e){return f(this,e,!1)}pop(){const e=this[u].tail;return e?(S(this,e),e.value):null}del(e){S(this,this[p].get(e))}load(e){this.reset();const t=Date.now();for(let r=e.length-1;r>=0;r--){const i=e[r],s=i.e||0;if(0===s)this.set(i.k,i.v);else{const e=s-t;e>0&&this.set(i.k,i.v,e)}}}prune(){this[p].forEach(((e,t)=>f(this,t,!1)))}}},2257:(e,t,r)=>{const i=Symbol("SemVer ANY");class s{static get ANY(){return i}constructor(e,t){if(t=n(t),e instanceof s){if(e.loose===!!t.loose)return e;e=e.value}l("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===i?this.value="":this.value=this.operator+this.semver.version,l("comp",this)}parse(e){const t=this.options.loose?o[a.COMPARATORLOOSE]:o[a.COMPARATOR],r=e.match(t);if(!r)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==r[1]?r[1]:"","="===this.operator&&(this.operator=""),r[2]?this.semver=new d(r[2],this.options.loose):this.semver=i}toString(){return this.value}test(e){if(l("Comparator.test",e,this.options.loose),this.semver===i||e===i)return!0;if("string"==typeof e)try{e=new d(e,this.options)}catch(e){return!1}return c(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof s))throw new TypeError("a Comparator is required");if(t&&"object"==typeof t||(t={loose:!!t,includePrerelease:!1}),""===this.operator)return""===this.value||new u(e.value,t).test(this.value);if(""===e.operator)return""===e.value||new u(this.value,t).test(e.semver);const r=!(">="!==this.operator&&">"!==this.operator||">="!==e.operator&&">"!==e.operator),i=!("<="!==this.operator&&"<"!==this.operator||"<="!==e.operator&&"<"!==e.operator),n=this.semver.version===e.semver.version,o=!(">="!==this.operator&&"<="!==this.operator||">="!==e.operator&&"<="!==e.operator),a=c(this.semver,"<",e.semver,t)&&(">="===this.operator||">"===this.operator)&&("<="===e.operator||"<"===e.operator),l=c(this.semver,">",e.semver,t)&&("<="===this.operator||"<"===this.operator)&&(">="===e.operator||">"===e.operator);return r||i||n&&o||a||l}}e.exports=s;const n=r(2893),{re:o,t:a}=r(5765),c=r(7539),l=r(4225),d=r(6376),u=r(6902)},6902:(e,t,r)=>{class i{constructor(e,t){if(t=n(t),e instanceof i)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new i(e.raw,t);if(e instanceof o)return this.raw=e.value,this.set=[[e]],this.format(),this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e,this.set=e.split("||").map((e=>this.parseRange(e.trim()))).filter((e=>e.length)),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${e}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter((e=>!m(e[0]))),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&f(e[0])){this.set=[e];break}}this.format()}format(){return this.range=this.set.map((e=>e.join(" ").trim())).join("||").trim(),this.range}toString(){return this.range}parseRange(e){e=e.trim();const t=`parseRange:${Object.keys(this.options).join(",")}:${e}`,r=s.get(t);if(r)return r;const i=this.options.loose,n=i?l[d.HYPHENRANGELOOSE]:l[d.HYPHENRANGE];e=e.replace(n,I(this.options.includePrerelease)),a("hyphen replace",e),e=e.replace(l[d.COMPARATORTRIM],u),a("comparator trim",e);let c=(e=(e=(e=e.replace(l[d.TILDETRIM],p)).replace(l[d.CARETTRIM],h)).split(/\s+/).join(" ")).split(" ").map((e=>v(e,this.options))).join(" ").split(/\s+/).map((e=>R(e,this.options)));i&&(c=c.filter((e=>(a("loose invalid filter",e,this.options),!!e.match(l[d.COMPARATORLOOSE]))))),a("range list",c);const f=new Map,g=c.map((e=>new o(e,this.options)));for(const e of g){if(m(e))return[e];f.set(e.value,e)}f.size>1&&f.has("")&&f.delete("");const S=[...f.values()];return s.set(t,S),S}intersects(e,t){if(!(e instanceof i))throw new TypeError("a Range is required");return this.set.some((r=>g(r,t)&&e.set.some((e=>g(e,t)&&r.every((r=>e.every((e=>r.intersects(e,t)))))))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new c(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(O(this.set[t],e,this.options))return!0;return!1}}e.exports=i;const s=new(r(9593))({max:1e3}),n=r(2893),o=r(2257),a=r(4225),c=r(6376),{re:l,t:d,comparatorTrimReplace:u,tildeTrimReplace:p,caretTrimReplace:h}=r(5765),m=e=>"<0.0.0-0"===e.value,f=e=>""===e.value,g=(e,t)=>{let r=!0;const i=e.slice();let s=i.pop();for(;r&&i.length;)r=i.every((e=>s.intersects(e,t))),s=i.pop();return r},v=(e,t)=>(a("comp",e,t),e=b(e,t),a("caret",e),e=y(e,t),a("tildes",e),e=E(e,t),a("xrange",e),e=T(e,t),a("stars",e),e),S=e=>!e||"x"===e.toLowerCase()||"*"===e,y=(e,t)=>e.trim().split(/\s+/).map((e=>_(e,t))).join(" "),_=(e,t)=>{const r=t.loose?l[d.TILDELOOSE]:l[d.TILDE];return e.replace(r,((t,r,i,s,n)=>{let o;return a("tilde",e,t,r,i,s,n),S(r)?o="":S(i)?o=`>=${r}.0.0 <${+r+1}.0.0-0`:S(s)?o=`>=${r}.${i}.0 <${r}.${+i+1}.0-0`:n?(a("replaceTilde pr",n),o=`>=${r}.${i}.${s}-${n} <${r}.${+i+1}.0-0`):o=`>=${r}.${i}.${s} <${r}.${+i+1}.0-0`,a("tilde return",o),o}))},b=(e,t)=>e.trim().split(/\s+/).map((e=>w(e,t))).join(" "),w=(e,t)=>{a("caret",e,t);const r=t.loose?l[d.CARETLOOSE]:l[d.CARET],i=t.includePrerelease?"-0":"";return e.replace(r,((t,r,s,n,o)=>{let c;return a("caret",e,t,r,s,n,o),S(r)?c="":S(s)?c=`>=${r}.0.0${i} <${+r+1}.0.0-0`:S(n)?c="0"===r?`>=${r}.${s}.0${i} <${r}.${+s+1}.0-0`:`>=${r}.${s}.0${i} <${+r+1}.0.0-0`:o?(a("replaceCaret pr",o),c="0"===r?"0"===s?`>=${r}.${s}.${n}-${o} <${r}.${s}.${+n+1}-0`:`>=${r}.${s}.${n}-${o} <${r}.${+s+1}.0-0`:`>=${r}.${s}.${n}-${o} <${+r+1}.0.0-0`):(a("no pr"),c="0"===r?"0"===s?`>=${r}.${s}.${n}${i} <${r}.${s}.${+n+1}-0`:`>=${r}.${s}.${n}${i} <${r}.${+s+1}.0-0`:`>=${r}.${s}.${n} <${+r+1}.0.0-0`),a("caret return",c),c}))},E=(e,t)=>(a("replaceXRanges",e,t),e.split(/\s+/).map((e=>P(e,t))).join(" ")),P=(e,t)=>{e=e.trim();const r=t.loose?l[d.XRANGELOOSE]:l[d.XRANGE];return e.replace(r,((r,i,s,n,o,c)=>{a("xRange",e,r,i,s,n,o,c);const l=S(s),d=l||S(n),u=d||S(o),p=u;return"="===i&&p&&(i=""),c=t.includePrerelease?"-0":"",l?r=">"===i||"<"===i?"<0.0.0-0":"*":i&&p?(d&&(n=0),o=0,">"===i?(i=">=",d?(s=+s+1,n=0,o=0):(n=+n+1,o=0)):"<="===i&&(i="<",d?s=+s+1:n=+n+1),"<"===i&&(c="-0"),r=`${i+s}.${n}.${o}${c}`):d?r=`>=${s}.0.0${c} <${+s+1}.0.0-0`:u&&(r=`>=${s}.${n}.0${c} <${s}.${+n+1}.0-0`),a("xRange return",r),r}))},T=(e,t)=>(a("replaceStars",e,t),e.trim().replace(l[d.STAR],"")),R=(e,t)=>(a("replaceGTE0",e,t),e.trim().replace(l[t.includePrerelease?d.GTE0PRE:d.GTE0],"")),I=e=>(t,r,i,s,n,o,a,c,l,d,u,p,h)=>`${r=S(i)?"":S(s)?`>=${i}.0.0${e?"-0":""}`:S(n)?`>=${i}.${s}.0${e?"-0":""}`:o?`>=${r}`:`>=${r}${e?"-0":""}`} ${c=S(l)?"":S(d)?`<${+l+1}.0.0-0`:S(u)?`<${l}.${+d+1}.0-0`:p?`<=${l}.${d}.${u}-${p}`:e?`<${l}.${d}.${+u+1}-0`:`<=${c}`}`.trim(),O=(e,t,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if(a(e[r].semver),e[r].semver!==o.ANY&&e[r].semver.prerelease.length>0){const i=e[r].semver;if(i.major===t.major&&i.minor===t.minor&&i.patch===t.patch)return!0}return!1}return!0}},6376:(e,t,r)=>{const i=r(4225),{MAX_LENGTH:s,MAX_SAFE_INTEGER:n}=r(3295),{re:o,t:a}=r(5765),c=r(2893),{compareIdentifiers:l}=r(6742);class d{constructor(e,t){if(t=c(t),e instanceof d){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid Version: ${e}`);if(e.length>s)throw new TypeError(`version is longer than ${s} characters`);i("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const r=e.trim().match(t.loose?o[a.LOOSE]:o[a.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>n||this.major<0)throw new TypeError("Invalid major version");if(this.minor>n||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>n||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map((e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<n)return t}return e})):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(i("SemVer.compare",this.version,this.options,e),!(e instanceof d)){if("string"==typeof e&&e===this.version)return 0;e=new d(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof d||(e=new d(e,this.options)),l(this.major,e.major)||l(this.minor,e.minor)||l(this.patch,e.patch)}comparePre(e){if(e instanceof d||(e=new d(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const r=this.prerelease[t],s=e.prerelease[t];if(i("prerelease compare",t,r,s),void 0===r&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===r)return-1;if(r!==s)return l(r,s)}while(++t)}compareBuild(e){e instanceof d||(e=new d(e,this.options));let t=0;do{const r=this.build[t],s=e.build[t];if(i("prerelease compare",t,r,s),void 0===r&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===r)return-1;if(r!==s)return l(r,s)}while(++t)}inc(e,t){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t),this.inc("pre",t);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t),this.inc("pre",t);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":if(0===this.prerelease.length)this.prerelease=[0];else{let e=this.prerelease.length;for(;--e>=0;)"number"==typeof this.prerelease[e]&&(this.prerelease[e]++,e=-2);-1===e&&this.prerelease.push(0)}t&&(0===l(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=[t,0]):this.prerelease=[t,0]);break;default:throw new Error(`invalid increment argument: ${e}`)}return this.format(),this.raw=this.version,this}}e.exports=d},3507:(e,t,r)=>{const i=r(3959);e.exports=(e,t)=>{const r=i(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null}},7539:(e,t,r)=>{const i=r(8718),s=r(1194),n=r(1312),o=r(5903),a=r(1544),c=r(2056);e.exports=(e,t,r,l)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return i(e,r,l);case"!=":return s(e,r,l);case">":return n(e,r,l);case">=":return o(e,r,l);case"<":return a(e,r,l);case"<=":return c(e,r,l);default:throw new TypeError(`Invalid operator: ${t}`)}}},9038:(e,t,r)=>{const i=r(6376),s=r(3959),{re:n,t:o}=r(5765);e.exports=(e,t)=>{if(e instanceof i)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let r=null;if((t=t||{}).rtl){let t;for(;(t=n[o.COERCERTL].exec(e))&&(!r||r.index+r[0].length!==e.length);)r&&t.index+t[0].length===r.index+r[0].length||(r=t),n[o.COERCERTL].lastIndex=t.index+t[1].length+t[2].length;n[o.COERCERTL].lastIndex=-1}else r=e.match(n[o.COERCE]);return null===r?null:s(`${r[2]}.${r[3]||"0"}.${r[4]||"0"}`,t)}},8880:(e,t,r)=>{const i=r(6376);e.exports=(e,t,r)=>{const s=new i(e,r),n=new i(t,r);return s.compare(n)||s.compareBuild(n)}},7880:(e,t,r)=>{const i=r(6269);e.exports=(e,t)=>i(e,t,!0)},6269:(e,t,r)=>{const i=r(6376);e.exports=(e,t,r)=>new i(e,r).compare(new i(t,r))},2378:(e,t,r)=>{const i=r(3959),s=r(8718);e.exports=(e,t)=>{if(s(e,t))return null;{const r=i(e),s=i(t),n=r.prerelease.length||s.prerelease.length,o=n?"pre":"",a=n?"prerelease":"";for(const e in r)if(("major"===e||"minor"===e||"patch"===e)&&r[e]!==s[e])return o+e;return a}}},8718:(e,t,r)=>{const i=r(6269);e.exports=(e,t,r)=>0===i(e,t,r)},1312:(e,t,r)=>{const i=r(6269);e.exports=(e,t,r)=>i(e,t,r)>0},5903:(e,t,r)=>{const i=r(6269);e.exports=(e,t,r)=>i(e,t,r)>=0},253:(e,t,r)=>{const i=r(6376);e.exports=(e,t,r,s)=>{"string"==typeof r&&(s=r,r=void 0);try{return new i(e instanceof i?e.version:e,r).inc(t,s).version}catch(e){return null}}},1544:(e,t,r)=>{const i=r(6269);e.exports=(e,t,r)=>i(e,t,r)<0},2056:(e,t,r)=>{const i=r(6269);e.exports=(e,t,r)=>i(e,t,r)<=0},8679:(e,t,r)=>{const i=r(6376);e.exports=(e,t)=>new i(e,t).major},7789:(e,t,r)=>{const i=r(6376);e.exports=(e,t)=>new i(e,t).minor},1194:(e,t,r)=>{const i=r(6269);e.exports=(e,t,r)=>0!==i(e,t,r)},3959:(e,t,r)=>{const{MAX_LENGTH:i}=r(3295),{re:s,t:n}=r(5765),o=r(6376),a=r(2893);e.exports=(e,t)=>{if(t=a(t),e instanceof o)return e;if("string"!=typeof e)return null;if(e.length>i)return null;if(!(t.loose?s[n.LOOSE]:s[n.FULL]).test(e))return null;try{return new o(e,t)}catch(e){return null}}},2358:(e,t,r)=>{const i=r(6376);e.exports=(e,t)=>new i(e,t).patch},7559:(e,t,r)=>{const i=r(3959);e.exports=(e,t)=>{const r=i(e,t);return r&&r.prerelease.length?r.prerelease:null}},9795:(e,t,r)=>{const i=r(6269);e.exports=(e,t,r)=>i(t,e,r)},3657:(e,t,r)=>{const i=r(8880);e.exports=(e,t)=>e.sort(((e,r)=>i(r,e,t)))},5712:(e,t,r)=>{const i=r(6902);e.exports=(e,t,r)=>{try{t=new i(t,r)}catch(e){return!1}return t.test(e)}},1100:(e,t,r)=>{const i=r(8880);e.exports=(e,t)=>e.sort(((e,r)=>i(e,r,t)))},6397:(e,t,r)=>{const i=r(3959);e.exports=(e,t)=>{const r=i(e,t);return r?r.version:null}},1249:(e,t,r)=>{const i=r(5765);e.exports={re:i.re,src:i.src,tokens:i.t,SEMVER_SPEC_VERSION:r(3295).SEMVER_SPEC_VERSION,SemVer:r(6376),compareIdentifiers:r(6742).compareIdentifiers,rcompareIdentifiers:r(6742).rcompareIdentifiers,parse:r(3959),valid:r(6397),clean:r(3507),inc:r(253),diff:r(2378),major:r(8679),minor:r(7789),patch:r(2358),prerelease:r(7559),compare:r(6269),rcompare:r(9795),compareLoose:r(7880),compareBuild:r(8880),sort:r(1100),rsort:r(3657),gt:r(1312),lt:r(1544),eq:r(8718),neq:r(1194),gte:r(5903),lte:r(2056),cmp:r(7539),coerce:r(9038),Comparator:r(2257),Range:r(6902),satisfies:r(5712),toComparators:r(1042),maxSatisfying:r(5775),minSatisfying:r(1657),minVersion:r(5316),validRange:r(9042),outside:r(6826),gtr:r(7606),ltr:r(32),intersects:r(2937),simplifyRange:r(7908),subset:r(799)}},3295:e=>{const t=Number.MAX_SAFE_INTEGER||9007199254740991;e.exports={SEMVER_SPEC_VERSION:"2.0.0",MAX_LENGTH:256,MAX_SAFE_INTEGER:t,MAX_SAFE_COMPONENT_LENGTH:16}},4225:e=>{const t="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};e.exports=t},6742:e=>{const t=/^[0-9]+$/,r=(e,r)=>{const i=t.test(e),s=t.test(r);return i&&s&&(e=+e,r=+r),e===r?0:i&&!s?-1:s&&!i?1:e<r?-1:1};e.exports={compareIdentifiers:r,rcompareIdentifiers:(e,t)=>r(t,e)}},2893:e=>{const t=["includePrerelease","loose","rtl"];e.exports=e=>e?"object"!=typeof e?{loose:!0}:t.filter((t=>e[t])).reduce(((e,t)=>(e[t]=!0,e)),{}):{}},5765:(e,t,r)=>{const{MAX_SAFE_COMPONENT_LENGTH:i}=r(3295),s=r(4225),n=(t=e.exports={}).re=[],o=t.src=[],a=t.t={};let c=0;const l=(e,t,r)=>{const i=c++;s(e,i,t),a[e]=i,o[i]=t,n[i]=new RegExp(t,r?"g":void 0)};l("NUMERICIDENTIFIER","0|[1-9]\\d*"),l("NUMERICIDENTIFIERLOOSE","[0-9]+"),l("NONNUMERICIDENTIFIER","\\d*[a-zA-Z-][a-zA-Z0-9-]*"),l("MAINVERSION",`(${o[a.NUMERICIDENTIFIER]})\\.(${o[a.NUMERICIDENTIFIER]})\\.(${o[a.NUMERICIDENTIFIER]})`),l("MAINVERSIONLOOSE",`(${o[a.NUMERICIDENTIFIERLOOSE]})\\.(${o[a.NUMERICIDENTIFIERLOOSE]})\\.(${o[a.NUMERICIDENTIFIERLOOSE]})`),l("PRERELEASEIDENTIFIER",`(?:${o[a.NUMERICIDENTIFIER]}|${o[a.NONNUMERICIDENTIFIER]})`),l("PRERELEASEIDENTIFIERLOOSE",`(?:${o[a.NUMERICIDENTIFIERLOOSE]}|${o[a.NONNUMERICIDENTIFIER]})`),l("PRERELEASE",`(?:-(${o[a.PRERELEASEIDENTIFIER]}(?:\\.${o[a.PRERELEASEIDENTIFIER]})*))`),l("PRERELEASELOOSE",`(?:-?(${o[a.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${o[a.PRERELEASEIDENTIFIERLOOSE]})*))`),l("BUILDIDENTIFIER","[0-9A-Za-z-]+"),l("BUILD",`(?:\\+(${o[a.BUILDIDENTIFIER]}(?:\\.${o[a.BUILDIDENTIFIER]})*))`),l("FULLPLAIN",`v?${o[a.MAINVERSION]}${o[a.PRERELEASE]}?${o[a.BUILD]}?`),l("FULL",`^${o[a.FULLPLAIN]}$`),l("LOOSEPLAIN",`[v=\\s]*${o[a.MAINVERSIONLOOSE]}${o[a.PRERELEASELOOSE]}?${o[a.BUILD]}?`),l("LOOSE",`^${o[a.LOOSEPLAIN]}$`),l("GTLT","((?:<|>)?=?)"),l("XRANGEIDENTIFIERLOOSE",`${o[a.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),l("XRANGEIDENTIFIER",`${o[a.NUMERICIDENTIFIER]}|x|X|\\*`),l("XRANGEPLAIN",`[v=\\s]*(${o[a.XRANGEIDENTIFIER]})(?:\\.(${o[a.XRANGEIDENTIFIER]})(?:\\.(${o[a.XRANGEIDENTIFIER]})(?:${o[a.PRERELEASE]})?${o[a.BUILD]}?)?)?`),l("XRANGEPLAINLOOSE",`[v=\\s]*(${o[a.XRANGEIDENTIFIERLOOSE]})(?:\\.(${o[a.XRANGEIDENTIFIERLOOSE]})(?:\\.(${o[a.XRANGEIDENTIFIERLOOSE]})(?:${o[a.PRERELEASELOOSE]})?${o[a.BUILD]}?)?)?`),l("XRANGE",`^${o[a.GTLT]}\\s*${o[a.XRANGEPLAIN]}$`),l("XRANGELOOSE",`^${o[a.GTLT]}\\s*${o[a.XRANGEPLAINLOOSE]}$`),l("COERCE",`(^|[^\\d])(\\d{1,${i}})(?:\\.(\\d{1,${i}}))?(?:\\.(\\d{1,${i}}))?(?:$|[^\\d])`),l("COERCERTL",o[a.COERCE],!0),l("LONETILDE","(?:~>?)"),l("TILDETRIM",`(\\s*)${o[a.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",l("TILDE",`^${o[a.LONETILDE]}${o[a.XRANGEPLAIN]}$`),l("TILDELOOSE",`^${o[a.LONETILDE]}${o[a.XRANGEPLAINLOOSE]}$`),l("LONECARET","(?:\\^)"),l("CARETTRIM",`(\\s*)${o[a.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",l("CARET",`^${o[a.LONECARET]}${o[a.XRANGEPLAIN]}$`),l("CARETLOOSE",`^${o[a.LONECARET]}${o[a.XRANGEPLAINLOOSE]}$`),l("COMPARATORLOOSE",`^${o[a.GTLT]}\\s*(${o[a.LOOSEPLAIN]})$|^$`),l("COMPARATOR",`^${o[a.GTLT]}\\s*(${o[a.FULLPLAIN]})$|^$`),l("COMPARATORTRIM",`(\\s*)${o[a.GTLT]}\\s*(${o[a.LOOSEPLAIN]}|${o[a.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",l("HYPHENRANGE",`^\\s*(${o[a.XRANGEPLAIN]})\\s+-\\s+(${o[a.XRANGEPLAIN]})\\s*$`),l("HYPHENRANGELOOSE",`^\\s*(${o[a.XRANGEPLAINLOOSE]})\\s+-\\s+(${o[a.XRANGEPLAINLOOSE]})\\s*$`),l("STAR","(<|>)?=?\\s*\\*"),l("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),l("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},7606:(e,t,r)=>{const i=r(6826);e.exports=(e,t,r)=>i(e,t,">",r)},2937:(e,t,r)=>{const i=r(6902);e.exports=(e,t,r)=>(e=new i(e,r),t=new i(t,r),e.intersects(t))},32:(e,t,r)=>{const i=r(6826);e.exports=(e,t,r)=>i(e,t,"<",r)},5775:(e,t,r)=>{const i=r(6376),s=r(6902);e.exports=(e,t,r)=>{let n=null,o=null,a=null;try{a=new s(t,r)}catch(e){return null}return e.forEach((e=>{a.test(e)&&(n&&-1!==o.compare(e)||(n=e,o=new i(n,r)))})),n}},1657:(e,t,r)=>{const i=r(6376),s=r(6902);e.exports=(e,t,r)=>{let n=null,o=null,a=null;try{a=new s(t,r)}catch(e){return null}return e.forEach((e=>{a.test(e)&&(n&&1!==o.compare(e)||(n=e,o=new i(n,r)))})),n}},5316:(e,t,r)=>{const i=r(6376),s=r(6902),n=r(1312);e.exports=(e,t)=>{e=new s(e,t);let r=new i("0.0.0");if(e.test(r))return r;if(r=new i("0.0.0-0"),e.test(r))return r;r=null;for(let t=0;t<e.set.length;++t){const s=e.set[t];let o=null;s.forEach((e=>{const t=new i(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":o&&!n(t,o)||(o=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}})),!o||r&&!n(r,o)||(r=o)}return r&&e.test(r)?r:null}},6826:(e,t,r)=>{const i=r(6376),s=r(2257),{ANY:n}=s,o=r(6902),a=r(5712),c=r(1312),l=r(1544),d=r(2056),u=r(5903);e.exports=(e,t,r,p)=>{let h,m,f,g,v;switch(e=new i(e,p),t=new o(t,p),r){case">":h=c,m=d,f=l,g=">",v=">=";break;case"<":h=l,m=u,f=c,g="<",v="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(a(e,t,p))return!1;for(let r=0;r<t.set.length;++r){const i=t.set[r];let o=null,a=null;if(i.forEach((e=>{e.semver===n&&(e=new s(">=0.0.0")),o=o||e,a=a||e,h(e.semver,o.semver,p)?o=e:f(e.semver,a.semver,p)&&(a=e)})),o.operator===g||o.operator===v)return!1;if((!a.operator||a.operator===g)&&m(e,a.semver))return!1;if(a.operator===v&&f(e,a.semver))return!1}return!0}},7908:(e,t,r)=>{const i=r(5712),s=r(6269);e.exports=(e,t,r)=>{const n=[];let o=null,a=null;const c=e.sort(((e,t)=>s(e,t,r)));for(const e of c){i(e,t,r)?(a=e,o||(o=e)):(a&&n.push([o,a]),a=null,o=null)}o&&n.push([o,null]);const l=[];for(const[e,t]of n)e===t?l.push(e):t||e!==c[0]?t?e===c[0]?l.push(`<=${t}`):l.push(`${e} - ${t}`):l.push(`>=${e}`):l.push("*");const d=l.join(" || "),u="string"==typeof t.raw?t.raw:String(t);return d.length<u.length?d:t}},799:(e,t,r)=>{const i=r(6902),s=r(2257),{ANY:n}=s,o=r(5712),a=r(6269),c=(e,t,r)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===n){if(1===t.length&&t[0].semver===n)return!0;e=r.includePrerelease?[new s(">=0.0.0-0")]:[new s(">=0.0.0")]}if(1===t.length&&t[0].semver===n){if(r.includePrerelease)return!0;t=[new s(">=0.0.0")]}const i=new Set;let c,u,p,h,m,f,g;for(const t of e)">"===t.operator||">="===t.operator?c=l(c,t,r):"<"===t.operator||"<="===t.operator?u=d(u,t,r):i.add(t.semver);if(i.size>1)return null;if(c&&u){if(p=a(c.semver,u.semver,r),p>0)return null;if(0===p&&(">="!==c.operator||"<="!==u.operator))return null}for(const e of i){if(c&&!o(e,String(c),r))return null;if(u&&!o(e,String(u),r))return null;for(const i of t)if(!o(e,String(i),r))return!1;return!0}let v=!(!u||r.includePrerelease||!u.semver.prerelease.length)&&u.semver,S=!(!c||r.includePrerelease||!c.semver.prerelease.length)&&c.semver;v&&1===v.prerelease.length&&"<"===u.operator&&0===v.prerelease[0]&&(v=!1);for(const e of t){if(g=g||">"===e.operator||">="===e.operator,f=f||"<"===e.operator||"<="===e.operator,c)if(S&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===S.major&&e.semver.minor===S.minor&&e.semver.patch===S.patch&&(S=!1),">"===e.operator||">="===e.operator){if(h=l(c,e,r),h===e&&h!==c)return!1}else if(">="===c.operator&&!o(c.semver,String(e),r))return!1;if(u)if(v&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===v.major&&e.semver.minor===v.minor&&e.semver.patch===v.patch&&(v=!1),"<"===e.operator||"<="===e.operator){if(m=d(u,e,r),m===e&&m!==u)return!1}else if("<="===u.operator&&!o(u.semver,String(e),r))return!1;if(!e.operator&&(u||c)&&0!==p)return!1}return!(c&&f&&!u&&0!==p)&&(!(u&&g&&!c&&0!==p)&&(!S&&!v))},l=(e,t,r)=>{if(!e)return t;const i=a(e.semver,t.semver,r);return i>0?e:i<0||">"===t.operator&&">="===e.operator?t:e},d=(e,t,r)=>{if(!e)return t;const i=a(e.semver,t.semver,r);return i<0?e:i>0||"<"===t.operator&&"<="===e.operator?t:e};e.exports=(e,t,r={})=>{if(e===t)return!0;e=new i(e,r),t=new i(t,r);let s=!1;e:for(const i of e.set){for(const e of t.set){const t=c(i,e,r);if(s=s||null!==t,t)continue e}if(s)return!1}return!0}},1042:(e,t,r)=>{const i=r(6902);e.exports=(e,t)=>new i(e,t).set.map((e=>e.map((e=>e.value)).join(" ").trim().split(" ")))},9042:(e,t,r)=>{const i=r(6902);e.exports=(e,t)=>{try{return new i(e,t).range||"*"}catch(e){return null}}},9602:e=>{"use strict";e.exports=function(e){e.prototype[Symbol.iterator]=function*(){for(let e=this.head;e;e=e.next)yield e.value}}},4411:(e,t,r)=>{"use strict";function i(e){var t=this;if(t instanceof i||(t=new i),t.tail=null,t.head=null,t.length=0,e&&"function"==typeof e.forEach)e.forEach((function(e){t.push(e)}));else if(arguments.length>0)for(var r=0,s=arguments.length;r<s;r++)t.push(arguments[r]);return t}function s(e,t,r){var i=t===e.head?new a(r,null,t,e):new a(r,t,t.next,e);return null===i.next&&(e.tail=i),null===i.prev&&(e.head=i),e.length++,i}function n(e,t){e.tail=new a(t,e.tail,null,e),e.head||(e.head=e.tail),e.length++}function o(e,t){e.head=new a(t,null,e.head,e),e.tail||(e.tail=e.head),e.length++}function a(e,t,r,i){if(!(this instanceof a))return new a(e,t,r,i);this.list=i,this.value=e,t?(t.next=this,this.prev=t):this.prev=null,r?(r.prev=this,this.next=r):this.next=null}e.exports=i,i.Node=a,i.create=i,i.prototype.removeNode=function(e){if(e.list!==this)throw new Error("removing node which does not belong to this list");var t=e.next,r=e.prev;return t&&(t.prev=r),r&&(r.next=t),e===this.head&&(this.head=t),e===this.tail&&(this.tail=r),e.list.length--,e.next=null,e.prev=null,e.list=null,t},i.prototype.unshiftNode=function(e){if(e!==this.head){e.list&&e.list.removeNode(e);var t=this.head;e.list=this,e.next=t,t&&(t.prev=e),this.head=e,this.tail||(this.tail=e),this.length++}},i.prototype.pushNode=function(e){if(e!==this.tail){e.list&&e.list.removeNode(e);var t=this.tail;e.list=this,e.prev=t,t&&(t.next=e),this.tail=e,this.head||(this.head=e),this.length++}},i.prototype.push=function(){for(var e=0,t=arguments.length;e<t;e++)n(this,arguments[e]);return this.length},i.prototype.unshift=function(){for(var e=0,t=arguments.length;e<t;e++)o(this,arguments[e]);return this.length},i.prototype.pop=function(){if(this.tail){var e=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}},i.prototype.shift=function(){if(this.head){var e=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}},i.prototype.forEach=function(e,t){t=t||this;for(var r=this.head,i=0;null!==r;i++)e.call(t,r.value,i,this),r=r.next},i.prototype.forEachReverse=function(e,t){t=t||this;for(var r=this.tail,i=this.length-1;null!==r;i--)e.call(t,r.value,i,this),r=r.prev},i.prototype.get=function(e){for(var t=0,r=this.head;null!==r&&t<e;t++)r=r.next;if(t===e&&null!==r)return r.value},i.prototype.getReverse=function(e){for(var t=0,r=this.tail;null!==r&&t<e;t++)r=r.prev;if(t===e&&null!==r)return r.value},i.prototype.map=function(e,t){t=t||this;for(var r=new i,s=this.head;null!==s;)r.push(e.call(t,s.value,this)),s=s.next;return r},i.prototype.mapReverse=function(e,t){t=t||this;for(var r=new i,s=this.tail;null!==s;)r.push(e.call(t,s.value,this)),s=s.prev;return r},i.prototype.reduce=function(e,t){var r,i=this.head;if(arguments.length>1)r=t;else{if(!this.head)throw new TypeError("Reduce of empty list with no initial value");i=this.head.next,r=this.head.value}for(var s=0;null!==i;s++)r=e(r,i.value,s),i=i.next;return r},i.prototype.reduceReverse=function(e,t){var r,i=this.tail;if(arguments.length>1)r=t;else{if(!this.tail)throw new TypeError("Reduce of empty list with no initial value");i=this.tail.prev,r=this.tail.value}for(var s=this.length-1;null!==i;s--)r=e(r,i.value,s),i=i.prev;return r},i.prototype.toArray=function(){for(var e=new Array(this.length),t=0,r=this.head;null!==r;t++)e[t]=r.value,r=r.next;return e},i.prototype.toArrayReverse=function(){for(var e=new Array(this.length),t=0,r=this.tail;null!==r;t++)e[t]=r.value,r=r.prev;return e},i.prototype.slice=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var r=new i;if(t<e||t<0)return r;e<0&&(e=0),t>this.length&&(t=this.length);for(var s=0,n=this.head;null!==n&&s<e;s++)n=n.next;for(;null!==n&&s<t;s++,n=n.next)r.push(n.value);return r},i.prototype.sliceReverse=function(e,t){(t=t||this.length)<0&&(t+=this.length),(e=e||0)<0&&(e+=this.length);var r=new i;if(t<e||t<0)return r;e<0&&(e=0),t>this.length&&(t=this.length);for(var s=this.length,n=this.tail;null!==n&&s>t;s--)n=n.prev;for(;null!==n&&s>e;s--,n=n.prev)r.push(n.value);return r},i.prototype.splice=function(e,t,...r){e>this.length&&(e=this.length-1),e<0&&(e=this.length+e);for(var i=0,n=this.head;null!==n&&i<e;i++)n=n.next;var o=[];for(i=0;n&&i<t;i++)o.push(n.value),n=this.removeNode(n);null===n&&(n=this.tail),n!==this.head&&n!==this.tail&&(n=n.prev);for(i=0;i<r.length;i++)n=s(this,n,r[i]);return o},i.prototype.reverse=function(){for(var e=this.head,t=this.tail,r=e;null!==r;r=r.prev){var i=r.prev;r.prev=r.next,r.next=i}return this.head=t,this.tail=e,this};try{r(9602)(i)}catch(e){}},7954:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),t.MixinDeviceBase=t.ScryptedDeviceBase=void 0,s(r(5492),t);const n=r(5492);class o extends n.DeviceBase{constructor(e){super(),this.nativeId=e}get storage(){return this._storage||(this._storage=deviceManager.getDeviceStorage(this.nativeId)),this._storage}get log(){return this._log||(this._log=deviceManager.getDeviceLogger(this.nativeId)),this._log}get console(){return this._console||(this._console=deviceManager.getDeviceConsole(this.nativeId)),this._console}async createMediaObject(e,t){return mediaManager.createMediaObject(e,t,{sourceId:this.id})}getMediaObjectConsole(e){return"string"!=typeof e.sourceId?this.console:deviceManager.getMixinConsole(e.sourceId,this.nativeId)}_lazyLoadDeviceState(){this._deviceState||(this.nativeId?this._deviceState=deviceManager.getDeviceState(this.nativeId):this._deviceState=deviceManager.getDeviceState())}onDeviceEvent(e,t){return deviceManager.onDeviceEvent(this.nativeId,e,t)}}t.ScryptedDeviceBase=o;class a extends n.DeviceBase{constructor(e){super(),this._listeners=new Set,this.nativeId=systemManager.getDeviceById(this.id)?.nativeId,this.mixinDevice=e.mixinDevice,this.mixinDeviceInterfaces=e.mixinDeviceInterfaces,this.mixinStorageSuffix=e.mixinStorageSuffix,this._deviceState=e.mixinDeviceState,this._deviceState.__rpcproxy_traps_all_properties&&deviceManager.createDeviceState&&"string"==typeof this._deviceState.id&&(this._deviceState=deviceManager.createDeviceState(this._deviceState.id,this._deviceState.setState)),this.mixinProviderNativeId=e.mixinProviderNativeId}get storage(){if(!this._storage){const e=this.mixinStorageSuffix,t=this.id+(e?":"+e:"");this._storage=deviceManager.getMixinStorage(t,this.mixinProviderNativeId)}return this._storage}get console(){return this._console||(deviceManager.getMixinConsole?this._console=deviceManager.getMixinConsole(this.id,this.mixinProviderNativeId):this._console=deviceManager.getDeviceConsole(this.mixinProviderNativeId)),this._console}async createMediaObject(e,t){return mediaManager.createMediaObject(e,t,{sourceId:this.id})}getMediaObjectConsole(e){return"string"!=typeof e.sourceId?this.console:deviceManager.getMixinConsole(e.sourceId,this.mixinProviderNativeId)}onDeviceEvent(e,t){return deviceManager.onMixinEvent(this.id,this,e,t)}_lazyLoadDeviceState(){}manageListener(e){this._listeners.add(e)}release(){for(const e of this._listeners)e.removeListener()}}t.MixinDeviceBase=a,function(){function e(e){return function(){return this._lazyLoadDeviceState(),this._deviceState?.[e]}}function t(e){return function(t){this._lazyLoadDeviceState(),this._deviceState?this._deviceState[e]=t:console.warn("device state is unavailable. the device must be discovered with deviceManager.onDeviceDiscovered or deviceManager.onDevicesChanged before the state can be set.")}}for(const r of Object.values(n.ScryptedInterfaceProperty))r!==n.ScryptedInterfaceProperty.nativeId&&(Object.defineProperty(o.prototype,r,{set:t(r),get:e(r)}),Object.defineProperty(a.prototype,r,{set:t(r),get:e(r)}))}();let c={};try{let e;try{e=pluginRuntimeAPI}catch(e){}c=Object.assign(c,{log:deviceManager.getDeviceLogger(void 0),deviceManager,endpointManager,mediaManager,systemManager,pluginHostAPI,...e});try{systemManager.setScryptedInterfaceDescriptors?.(n.TYPES_VERSION,n.ScryptedInterfaceDescriptors)?.catch((()=>{}))}catch(e){}}catch(e){console.error("sdk initialization error, import @scrypted/types or use @scrypted/client instead",e)}t.default=c},8202:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.StorageSettings=void 0;const o=n(r(7954)),{systemManager:a}=o.default;t.StorageSettings=class{constructor(e,t){this.device=e,this.settings=t,this.values={},this.hasValue={};for(const e of Object.keys(t)){const r=t[e],i=()=>this.getItem(e);let s;s="clippath"!==r.type?i:()=>{try{return JSON.parse(i())}catch(e){}},Object.defineProperty(this.values,e,{get:s,set:t=>this.putSetting(e,t),enumerable:!0}),Object.defineProperty(this.hasValue,e,{get:()=>null!=this.device.storage.getItem(e),enumerable:!0})}}get keys(){const e={};for(const t of Object.keys(this.settings))e[t]=t;return e}async getSettings(){const e=await(this.options?.onGet?.()),t=[];for(const[r,i]of Object.entries(this.settings)){let s=Object.assign({},i);e?.[r]&&(s=Object.assign(s,e[r])),s.onGet&&(s=Object.assign(s,await s.onGet())),s.hide||await(this.options?.hide?.[r]?.())||(s.key=r,s.value=this.getItemInternal(r,s,!0),t.push(s),delete s.onPut,delete s.onGet,delete s.mapPut,delete s.mapGet)}return t}async putSetting(e,t){const r=this.settings[e];let i;return r&&(i=this.getItemInternal(e,r)),this.putSettingInternal(r,i,e,t)}putSettingInternal(e,t,r,i){e?.noStore||(e?.mapPut&&(i=e.mapPut(t,i)),"object"==typeof i?this.device.storage.setItem(r,JSON.stringify(i)):this.device.storage.setItem(r,i?.toString())),e?.onPut?.(t,i),this.device.onDeviceEvent(o.ScryptedInterface.Settings,void 0)}getItemInternal(e,t,r){if(!t)return this.device.storage.getItem(e);const i=function(e,t,r,i){const s=t.multiple?"array":t.type;if("boolean"===s)return"true"===e||"false"!==e&&(r()||!1);if("number"===s)return parseFloat(e)||r()||0;if("integer"===s)return parseInt(e)||r()||0;if("array"===s)try{return JSON.parse(e)}catch(e){return r()||[]}if("device"===s)return i?e:a.getDeviceById(e)||a.getDeviceById(r());if(e&&t.json)try{return JSON.parse(e)}catch(e){return r()}return e||r()}(this.device.storage.getItem(e),t,(()=>t.persistedDefaultValue?(this.putSettingInternal(t,void 0,e,t.persistedDefaultValue),t.persistedDefaultValue):t.defaultValue),r);return t.mapGet?t.mapGet(i):i}getItem(e){return this.getItemInternal(e,this.settings[e])}}},5492:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScryptedMimeTypes=t.ScryptedInterface=t.MediaPlayerState=t.SecuritySystemObstruction=t.SecuritySystemMode=t.AirQuality=t.ChargeState=t.LockState=t.PanTiltZoomMovement=t.ThermostatMode=t.TemperatureUnit=t.FanMode=t.HumidityMode=t.ScryptedDeviceType=t.ScryptedInterfaceDescriptors=t.ScryptedInterfaceMethod=t.ScryptedInterfaceProperty=t.DeviceBase=t.TYPES_VERSION=void 0,t.TYPES_VERSION="0.2.78";t.DeviceBase=class{},function(e){e.id="id",e.info="info",e.interfaces="interfaces",e.mixins="mixins",e.name="name",e.nativeId="nativeId",e.pluginId="pluginId",e.providedInterfaces="providedInterfaces",e.providedName="providedName",e.providedRoom="providedRoom",e.providedType="providedType",e.providerId="providerId",e.room="room",e.type="type",e.on="on",e.brightness="brightness",e.colorTemperature="colorTemperature",e.rgb="rgb",e.hsv="hsv",e.running="running",e.paused="paused",e.docked="docked",e.temperatureSetting="temperatureSetting",e.thermostatActiveMode="thermostatActiveMode",e.thermostatAvailableModes="thermostatAvailableModes",e.thermostatMode="thermostatMode",e.thermostatSetpoint="thermostatSetpoint",e.thermostatSetpointHigh="thermostatSetpointHigh",e.thermostatSetpointLow="thermostatSetpointLow",e.temperature="temperature",e.temperatureUnit="temperatureUnit",e.humidity="humidity",e.ptzCapabilities="ptzCapabilities",e.lockState="lockState",e.entryOpen="entryOpen",e.batteryLevel="batteryLevel",e.chargeState="chargeState",e.online="online",e.fromMimeType="fromMimeType",e.toMimeType="toMimeType",e.binaryState="binaryState",e.tampered="tampered",e.powerDetected="powerDetected",e.audioDetected="audioDetected",e.motionDetected="motionDetected",e.ambientLight="ambientLight",e.occupied="occupied",e.flooded="flooded",e.ultraviolet="ultraviolet",e.luminance="luminance",e.position="position",e.securitySystemState="securitySystemState",e.pm10Density="pm10Density",e.pm25Density="pm25Density",e.vocDensity="vocDensity",e.noxDensity="noxDensity",e.co2ppm="co2ppm",e.airQuality="airQuality",e.humiditySetting="humiditySetting",e.fan="fan",e.applicationInfo="applicationInfo"}(t.ScryptedInterfaceProperty||(t.ScryptedInterfaceProperty={})),function(e){e.listen="listen",e.probe="probe",e.setMixins="setMixins",e.setName="setName",e.setRoom="setRoom",e.setType="setType",e.getPluginJson="getPluginJson",e.turnOff="turnOff",e.turnOn="turnOn",e.setBrightness="setBrightness",e.getTemperatureMaxK="getTemperatureMaxK",e.getTemperatureMinK="getTemperatureMinK",e.setColorTemperature="setColorTemperature",e.setRgb="setRgb",e.setHsv="setHsv",e.sendNotification="sendNotification",e.start="start",e.stop="stop",e.pause="pause",e.resume="resume",e.dock="dock",e.setTemperature="setTemperature",e.setThermostatMode="setThermostatMode",e.setThermostatSetpoint="setThermostatSetpoint",e.setThermostatSetpointHigh="setThermostatSetpointHigh",e.setThermostatSetpointLow="setThermostatSetpointLow",e.setTemperatureUnit="setTemperatureUnit",e.getPictureOptions="getPictureOptions",e.takePicture="takePicture",e.getAudioStream="getAudioStream",e.startDisplay="startDisplay",e.stopDisplay="stopDisplay",e.getVideoStream="getVideoStream",e.getVideoStreamOptions="getVideoStreamOptions",e.getRecordingStream="getRecordingStream",e.getRecordingStreamCurrentTime="getRecordingStreamCurrentTime",e.getRecordingStreamOptions="getRecordingStreamOptions",e.getRecordingStreamThumbnail="getRecordingStreamThumbnail",e.ptzCommand="ptzCommand",e.getRecordedEvents="getRecordedEvents",e.getVideoClip="getVideoClip",e.getVideoClipThumbnail="getVideoClipThumbnail",e.getVideoClips="getVideoClips",e.removeVideoClips="removeVideoClips",e.setVideoStreamOptions="setVideoStreamOptions",e.startIntercom="startIntercom",e.stopIntercom="stopIntercom",e.lock="lock",e.unlock="unlock",e.addPassword="addPassword",e.getPasswords="getPasswords",e.removePassword="removePassword",e.activate="activate",e.deactivate="deactivate",e.isReversible="isReversible",e.closeEntry="closeEntry",e.openEntry="openEntry",e.getDevice="getDevice",e.releaseDevice="releaseDevice",e.adoptDevice="adoptDevice",e.discoverDevices="discoverDevices",e.createDevice="createDevice",e.getCreateDeviceSettings="getCreateDeviceSettings",e.getRefreshFrequency="getRefreshFrequency",e.refresh="refresh",e.getMediaStatus="getMediaStatus",e.load="load",e.seek="seek",e.skipNext="skipNext",e.skipPrevious="skipPrevious",e.convert="convert",e.getSettings="getSettings",e.putSetting="putSetting",e.armSecuritySystem="armSecuritySystem",e.disarmSecuritySystem="disarmSecuritySystem",e.getReadmeMarkdown="getReadmeMarkdown",e.getOauthUrl="getOauthUrl",e.onOauthCallback="onOauthCallback",e.canMixin="canMixin",e.getMixin="getMixin",e.releaseMixin="releaseMixin",e.onRequest="onRequest",e.onConnection="onConnection",e.onPush="onPush",e.run="run",e.eval="eval",e.loadScripts="loadScripts",e.saveScript="saveScript",e.trackObjects="trackObjects",e.getDetectionInput="getDetectionInput",e.getObjectTypes="getObjectTypes",e.detectObjects="detectObjects",e.generateObjectDetections="generateObjectDetections",e.getDetectionModel="getDetectionModel",e.setHumidity="setHumidity",e.setFan="setFan",e.startRTCSignalingSession="startRTCSignalingSession",e.createRTCSignalingSession="createRTCSignalingSession",e.getScryptedUserAccessControl="getScryptedUserAccessControl",e.generateVideoFrames="generateVideoFrames"}(t.ScryptedInterfaceMethod||(t.ScryptedInterfaceMethod={})),t.ScryptedInterfaceDescriptors={ScryptedDevice:{name:"ScryptedDevice",methods:["listen","probe","setMixins","setName","setRoom","setType"],properties:["id","info","interfaces","mixins","name","nativeId","pluginId","providedInterfaces","providedName","providedRoom","providedType","providerId","room","type"]},ScryptedPlugin:{name:"ScryptedPlugin",methods:["getPluginJson"],properties:[]},OnOff:{name:"OnOff",methods:["turnOff","turnOn"],properties:["on"]},Brightness:{name:"Brightness",methods:["setBrightness"],properties:["brightness"]},ColorSettingTemperature:{name:"ColorSettingTemperature",methods:["getTemperatureMaxK","getTemperatureMinK","setColorTemperature"],properties:["colorTemperature"]},ColorSettingRgb:{name:"ColorSettingRgb",methods:["setRgb"],properties:["rgb"]},ColorSettingHsv:{name:"ColorSettingHsv",methods:["setHsv"],properties:["hsv"]},Notifier:{name:"Notifier",methods:["sendNotification"],properties:[]},StartStop:{name:"StartStop",methods:["start","stop"],properties:["running"]},Pause:{name:"Pause",methods:["pause","resume"],properties:["paused"]},Dock:{name:"Dock",methods:["dock"],properties:["docked"]},TemperatureSetting:{name:"TemperatureSetting",methods:["setTemperature","setThermostatMode","setThermostatSetpoint","setThermostatSetpointHigh","setThermostatSetpointLow"],properties:["temperatureSetting","thermostatActiveMode","thermostatAvailableModes","thermostatMode","thermostatSetpoint","thermostatSetpointHigh","thermostatSetpointLow"]},Thermometer:{name:"Thermometer",methods:["setTemperatureUnit"],properties:["temperature","temperatureUnit"]},HumiditySensor:{name:"HumiditySensor",methods:[],properties:["humidity"]},Camera:{name:"Camera",methods:["getPictureOptions","takePicture"],properties:[]},Microphone:{name:"Microphone",methods:["getAudioStream"],properties:[]},Display:{name:"Display",methods:["startDisplay","stopDisplay"],properties:[]},VideoCamera:{name:"VideoCamera",methods:["getVideoStream","getVideoStreamOptions"],properties:[]},VideoRecorder:{name:"VideoRecorder",methods:["getRecordingStream","getRecordingStreamCurrentTime","getRecordingStreamOptions","getRecordingStreamThumbnail"],properties:[]},PanTiltZoom:{name:"PanTiltZoom",methods:["ptzCommand"],properties:["ptzCapabilities"]},EventRecorder:{name:"EventRecorder",methods:["getRecordedEvents"],properties:[]},VideoClips:{name:"VideoClips",methods:["getVideoClip","getVideoClipThumbnail","getVideoClips","removeVideoClips"],properties:[]},VideoCameraConfiguration:{name:"VideoCameraConfiguration",methods:["setVideoStreamOptions"],properties:[]},Intercom:{name:"Intercom",methods:["startIntercom","stopIntercom"],properties:[]},Lock:{name:"Lock",methods:["lock","unlock"],properties:["lockState"]},PasswordStore:{name:"PasswordStore",methods:["addPassword","getPasswords","removePassword"],properties:[]},Scene:{name:"Scene",methods:["activate","deactivate","isReversible"],properties:[]},Entry:{name:"Entry",methods:["closeEntry","openEntry"],properties:[]},EntrySensor:{name:"EntrySensor",methods:[],properties:["entryOpen"]},DeviceProvider:{name:"DeviceProvider",methods:["getDevice","releaseDevice"],properties:[]},DeviceDiscovery:{name:"DeviceDiscovery",methods:["adoptDevice","discoverDevices"],properties:[]},DeviceCreator:{name:"DeviceCreator",methods:["createDevice","getCreateDeviceSettings"],properties:[]},Battery:{name:"Battery",methods:[],properties:["batteryLevel"]},Charger:{name:"Charger",methods:[],properties:["chargeState"]},Refresh:{name:"Refresh",methods:["getRefreshFrequency","refresh"],properties:[]},MediaPlayer:{name:"MediaPlayer",methods:["getMediaStatus","load","seek","skipNext","skipPrevious"],properties:[]},Online:{name:"Online",methods:[],properties:["online"]},BufferConverter:{name:"BufferConverter",methods:["convert"],properties:["fromMimeType","toMimeType"]},Settings:{name:"Settings",methods:["getSettings","putSetting"],properties:[]},BinarySensor:{name:"BinarySensor",methods:[],properties:["binaryState"]},TamperSensor:{name:"TamperSensor",methods:[],properties:["tampered"]},PowerSensor:{name:"PowerSensor",methods:[],properties:["powerDetected"]},AudioSensor:{name:"AudioSensor",methods:[],properties:["audioDetected"]},MotionSensor:{name:"MotionSensor",methods:[],properties:["motionDetected"]},AmbientLightSensor:{name:"AmbientLightSensor",methods:[],properties:["ambientLight"]},OccupancySensor:{name:"OccupancySensor",methods:[],properties:["occupied"]},FloodSensor:{name:"FloodSensor",methods:[],properties:["flooded"]},UltravioletSensor:{name:"UltravioletSensor",methods:[],properties:["ultraviolet"]},LuminanceSensor:{name:"LuminanceSensor",methods:[],properties:["luminance"]},PositionSensor:{name:"PositionSensor",methods:[],properties:["position"]},SecuritySystem:{name:"SecuritySystem",methods:["armSecuritySystem","disarmSecuritySystem"],properties:["securitySystemState"]},PM10Sensor:{name:"PM10Sensor",methods:[],properties:["pm10Density"]},PM25Sensor:{name:"PM25Sensor",methods:[],properties:["pm25Density"]},VOCSensor:{name:"VOCSensor",methods:[],properties:["vocDensity"]},NOXSensor:{name:"NOXSensor",methods:[],properties:["noxDensity"]},CO2Sensor:{name:"CO2Sensor",methods:[],properties:["co2ppm"]},AirQualitySensor:{name:"AirQualitySensor",methods:[],properties:["airQuality"]},Readme:{name:"Readme",methods:["getReadmeMarkdown"],properties:[]},OauthClient:{name:"OauthClient",methods:["getOauthUrl","onOauthCallback"],properties:[]},MixinProvider:{name:"MixinProvider",methods:["canMixin","getMixin","releaseMixin"],properties:[]},HttpRequestHandler:{name:"HttpRequestHandler",methods:["onRequest"],properties:[]},EngineIOHandler:{name:"EngineIOHandler",methods:["onConnection"],properties:[]},PushHandler:{name:"PushHandler",methods:["onPush"],properties:[]},Program:{name:"Program",methods:["run"],properties:[]},Scriptable:{name:"Scriptable",methods:["eval","loadScripts","saveScript"],properties:[]},ObjectTracker:{name:"ObjectTracker",methods:["trackObjects"],properties:[]},ObjectDetector:{name:"ObjectDetector",methods:["getDetectionInput","getObjectTypes"],properties:[]},ObjectDetection:{name:"ObjectDetection",methods:["detectObjects","generateObjectDetections","getDetectionModel"],properties:[]},HumiditySetting:{name:"HumiditySetting",methods:["setHumidity"],properties:["humiditySetting"]},Fan:{name:"Fan",methods:["setFan"],properties:["fan"]},RTCSignalingChannel:{name:"RTCSignalingChannel",methods:["startRTCSignalingSession"],properties:[]},RTCSignalingClient:{name:"RTCSignalingClient",methods:["createRTCSignalingSession"],properties:[]},LauncherApplication:{name:"LauncherApplication",methods:[],properties:["applicationInfo"]},ScryptedUser:{name:"ScryptedUser",methods:["getScryptedUserAccessControl"],properties:[]},VideoFrameGenerator:{name:"VideoFrameGenerator",methods:["generateVideoFrames"],properties:[]}},function(e){e.Builtin="Builtin",e.Camera="Camera",e.Fan="Fan",e.Light="Light",e.Switch="Switch",e.Outlet="Outlet",e.Sensor="Sensor",e.Scene="Scene",e.Program="Program",e.Automation="Automation",e.Vacuum="Vacuum",e.Notifier="Notifier",e.Thermostat="Thermostat",e.Lock="Lock",e.PasswordControl="PasswordControl",e.Display="Display",e.SmartDisplay="SmartDisplay",e.Speaker="Speaker",e.SmartSpeaker="SmartSpeaker",e.Event="Event",e.Entry="Entry",e.Garage="Garage",e.DeviceProvider="DeviceProvider",e.DataSource="DataSource",e.API="API",e.Doorbell="Doorbell",e.Irrigation="Irrigation",e.Valve="Valve",e.Person="Person",e.SecuritySystem="SecuritySystem",e.WindowCovering="WindowCovering",e.Siren="Siren",e.Unknown="Unknown"}(t.ScryptedDeviceType||(t.ScryptedDeviceType={})),function(e){e.Humidify="Humidify",e.Dehumidify="Dehumidify",e.Auto="Auto",e.Off="Off"}(t.HumidityMode||(t.HumidityMode={})),function(e){e.Auto="Auto",e.Manual="Manual"}(t.FanMode||(t.FanMode={})),function(e){e.C="C",e.F="F"}(t.TemperatureUnit||(t.TemperatureUnit={})),function(e){e.Off="Off",e.Cool="Cool",e.Heat="Heat",e.HeatCool="HeatCool",e.Auto="Auto",e.FanOnly="FanOnly",e.Purifier="Purifier",e.Eco="Eco",e.Dry="Dry",e.On="On"}(t.ThermostatMode||(t.ThermostatMode={})),function(e){e.Absolute="Absolute",e.Relative="Relative"}(t.PanTiltZoomMovement||(t.PanTiltZoomMovement={})),function(e){e.Locked="Locked",e.Unlocked="Unlocked",e.Jammed="Jammed"}(t.LockState||(t.LockState={})),function(e){e.Trickle="trickle",e.Charging="charging",e.NotCharging="not-charging"}(t.ChargeState||(t.ChargeState={})),function(e){e.Unknown="Unknown",e.Excellent="Excellent",e.Good="Good",e.Fair="Fair",e.Inferior="Inferior",e.Poor="Poor"}(t.AirQuality||(t.AirQuality={})),function(e){e.Disarmed="Disarmed",e.HomeArmed="HomeArmed",e.AwayArmed="AwayArmed",e.NightArmed="NightArmed"}(t.SecuritySystemMode||(t.SecuritySystemMode={})),function(e){e.Sensor="Sensor",e.Occupied="Occupied",e.Time="Time",e.Error="Error"}(t.SecuritySystemObstruction||(t.SecuritySystemObstruction={})),function(e){e.Idle="Idle",e.Playing="Playing",e.Paused="Paused",e.Buffering="Buffering"}(t.MediaPlayerState||(t.MediaPlayerState={})),function(e){e.ScryptedDevice="ScryptedDevice",e.ScryptedPlugin="ScryptedPlugin",e.OnOff="OnOff",e.Brightness="Brightness",e.ColorSettingTemperature="ColorSettingTemperature",e.ColorSettingRgb="ColorSettingRgb",e.ColorSettingHsv="ColorSettingHsv",e.Notifier="Notifier",e.StartStop="StartStop",e.Pause="Pause",e.Dock="Dock",e.TemperatureSetting="TemperatureSetting",e.Thermometer="Thermometer",e.HumiditySensor="HumiditySensor",e.Camera="Camera",e.Microphone="Microphone",e.Display="Display",e.VideoCamera="VideoCamera",e.VideoRecorder="VideoRecorder",e.PanTiltZoom="PanTiltZoom",e.EventRecorder="EventRecorder",e.VideoClips="VideoClips",e.VideoCameraConfiguration="VideoCameraConfiguration",e.Intercom="Intercom",e.Lock="Lock",e.PasswordStore="PasswordStore",e.Scene="Scene",e.Entry="Entry",e.EntrySensor="EntrySensor",e.DeviceProvider="DeviceProvider",e.DeviceDiscovery="DeviceDiscovery",e.DeviceCreator="DeviceCreator",e.Battery="Battery",e.Charger="Charger",e.Refresh="Refresh",e.MediaPlayer="MediaPlayer",e.Online="Online",e.BufferConverter="BufferConverter",e.Settings="Settings",e.BinarySensor="BinarySensor",e.TamperSensor="TamperSensor",e.PowerSensor="PowerSensor",e.AudioSensor="AudioSensor",e.MotionSensor="MotionSensor",e.AmbientLightSensor="AmbientLightSensor",e.OccupancySensor="OccupancySensor",e.FloodSensor="FloodSensor",e.UltravioletSensor="UltravioletSensor",e.LuminanceSensor="LuminanceSensor",e.PositionSensor="PositionSensor",e.SecuritySystem="SecuritySystem",e.PM10Sensor="PM10Sensor",e.PM25Sensor="PM25Sensor",e.VOCSensor="VOCSensor",e.NOXSensor="NOXSensor",e.CO2Sensor="CO2Sensor",e.AirQualitySensor="AirQualitySensor",e.Readme="Readme",e.OauthClient="OauthClient",e.MixinProvider="MixinProvider",e.HttpRequestHandler="HttpRequestHandler",e.EngineIOHandler="EngineIOHandler",e.PushHandler="PushHandler",e.Program="Program",e.Scriptable="Scriptable",e.ObjectTracker="ObjectTracker",e.ObjectDetector="ObjectDetector",e.ObjectDetection="ObjectDetection",e.HumiditySetting="HumiditySetting",e.Fan="Fan",e.RTCSignalingChannel="RTCSignalingChannel",e.RTCSignalingClient="RTCSignalingClient",e.LauncherApplication="LauncherApplication",e.ScryptedUser="ScryptedUser",e.VideoFrameGenerator="VideoFrameGenerator"}(t.ScryptedInterface||(t.ScryptedInterface={})),function(e){e.Url="text/x-uri",e.InsecureLocalUrl="text/x-insecure-local-uri",e.LocalUrl="text/x-local-uri",e.PushEndpoint="text/x-push-endpoint",e.SchemePrefix="x-scrypted/x-scrypted-scheme-",e.MediaStreamUrl="text/x-media-url",e.MediaObject="x-scrypted/x-scrypted-media-object",e.RequestMediaObject="x-scrypted/x-scrypted-request-media-object",e.RequestMediaStream="x-scrypted/x-scrypted-request-stream",e.MediaStreamFeedback="x-scrypted/x-media-stream-feedback",e.FFmpegInput="x-scrypted/x-ffmpeg-input",e.FFmpegTranscodeStream="x-scrypted/x-ffmpeg-transcode-stream",e.RTCSignalingChannel="x-scrypted/x-scrypted-rtc-signaling-channel",e.RTCSignalingSession="x-scrypted/x-scrypted-rtc-signaling-session",e.RTCConnectionManagement="x-scrypted/x-scrypted-rtc-connection-management",e.Image="x-scrypted/x-scrypted-image"}(t.ScryptedMimeTypes||(t.ScryptedMimeTypes={}))},7817:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AutoenableMixinProvider=void 0;const s=r(7954),n=i(r(7954)),{systemManager:o}=n.default,a="v4";class c extends s.ScryptedDeviceBase{constructor(e){super(e),this.hasEnabledMixin={},this.unshiftMixin=!1;try{this.hasEnabledMixin=JSON.parse(this.storage.getItem("hasEnabledMixin"))}catch(e){this.hasEnabledMixin={}}this.pluginsComponent=o.getComponent("plugins"),o.listen((async(e,t,r)=>{t.eventInterface!==s.ScryptedInterface.ScryptedDevice||t.property||this.maybeEnableMixin(e)}));for(const e of Object.keys(o.getSystemState())){const t=o.getDeviceById(e);this.maybeEnableMixin(t)}}async shouldEnableMixin(e){return!0}async maybeEnableMixin(e){if(!e||e.mixins?.includes(this.id))return;if(this.hasEnabledMixin[e.id]===a)return;if(!await this.canMixin(e.type,e.interfaces))return;if(!await this.shouldEnableMixin(e))return;this.log.i("auto enabling mixin for "+e.name);const t=(e.mixins||[]).slice();this.unshiftMixin?t.unshift(this.id):t.push(this.id);const r=await this.pluginsComponent;await r.setMixins(e.id,t),this.setHasEnabledMixin(e.id)}setHasEnabledMixin(e){this.hasEnabledMixin[e]!==a&&(this.hasEnabledMixin[e]=a,this.storage.setItem("hasEnabledMixin",JSON.stringify(this.hasEnabledMixin)))}}t.AutoenableMixinProvider=c},4942:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cloneDeep=void 0,t.cloneDeep=function(e){if(e)return JSON.parse(JSON.stringify(e))}},6405:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Deferred=void 0;t.Deferred=class{constructor(){this.finished=!1,this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.finished=!0,e(t)},this.reject=e=>{this.finished=!0,t(e)}}))}}},7488:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getDebugModeH264EncoderArgs=t.getH264EncoderArgs=t.getH264DecoderArgs=t.isRaspberryPi=void 0;const s=i(r(2037)),n=["BCM2708","BCM2709","BCM2710","BCM2835","BCM2836","BCM2837","BCM2837B0","BCM2711"];function o(){let e;try{e=r(1158).readFileSync("/proc/cpuinfo",{encoding:"utf8"})}catch(e){return!1}const t=e.split("\n").map((e=>e.replace(/\t/g,""))).filter((e=>e.length>0)).map((e=>e.split(":"))).map((e=>e.map((e=>e.trim())))).filter((e=>"Hardware"===e[0]));if(!t||0==t.length)return!1;return function(e){return n.indexOf(e)>-1}(t[0][1])}t.isRaspberryPi=o;const a="Video4Linux (Docker compatible)";t.getH264DecoderArgs=function(){if(o()){return{}}if("darwin"===s.default.platform())return{VideoToolbox:["-hwaccel","auto"]};const e={"Nvidia CUDA":["-vsync","0","-hwaccel","cuda","-hwaccel_output_format","nv12"],"Nvidia CUVID":["-vsync","0","-hwaccel","cuvid","-c:v","h264_cuvid","-hwaccel_output_format","nv12"]};if(o())e["Raspberry Pi"]=["-c:v","h264_mmal"],e[a]=["-c:v","h264_v4l2m2m"];else if("linux"===s.default.platform())e[a]=["-c:v","h264_v4l2m2m"];else{if("win32"!==s.default.platform())return{};e["Intel QuickSync"]=["-c:v","h264_qsv"]}return e};function c(){return["-c:v","libx264","-pix_fmt","yuvj420p","-preset","ultrafast","-bf","0"]}t.getH264EncoderArgs=function(){const e={"Copy Video, Transcode Audio":"copy"};o()||("darwin"===s.default.platform()?e.VideoToolbox="h264_videotoolbox":"win32"===s.default.platform()?(e["Intel QuickSync"]="h264_qsv",e.AMD="h264_amf",e.Nvidia="h264_nvenc"):"linux"===s.default.platform()&&(e.V4L2="h264_v4l2m2m",e.VAAPI="h264_vaapi",e.Nvidia="h264_nvenc"));const t={};for(const[r,i]of Object.entries(e))t[r]=["-c:v",i];return o()&&(t["Raspberry Pi"]=["-pix_fmt","yuv420p","-c:v","h264_v4l2m2m"]),t["libx264 (Software)"]=["-c:v","libx264","-pix_fmt","yuvj420p","-preset","ultrafast","-bf","0"],t},t.getDebugModeH264EncoderArgs=c},9934:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addVideoFilterArguments=void 0,t.addVideoFilterArguments=function(e,t,r="unfilteredRecording"){const i=e.findIndex((e=>"-filter_complex"===e));void 0!==i&&-1!==i?e[i+1]=e[i+1]+`[${r}] ; [${r}] ${t}`:e.push("-filter_complex",t)}},7131:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.startFFMPegFragmentedMP4Session=t.FFMPEG_FRAGMENTED_MP4_OUTPUT_ARGS=t.parseFragmentedMP4=void 0;const s=i(r(2081)),n=i(r(7954)),o=r(4921),a=r(6521),{mediaManager:c}=n.default;async function*l(e){for(;;){const t=await(0,a.readLength)(e,8),r=t.readInt32BE(0)-8,i=t.slice(4).toString(),s=await(0,a.readLength)(e,r);yield{header:t,length:r,type:i,data:s}}}t.parseFragmentedMP4=l,t.FFMPEG_FRAGMENTED_MP4_OUTPUT_ARGS=["-movflags","frag_keyframe+empty_moov+default_base_moof+skip_sidx+skip_trailer","-f","mp4"],t.startFFMPegFragmentedMP4Session=async function(e,r,i,n){const a=e.slice();a.push(...i,...r,...t.FFMPEG_FRAGMENTED_MP4_OUTPUT_ARGS,"pipe:3"),a.unshift("-hide_banner"),(0,o.safePrintFFmpegArguments)(n,a);const d=s.default.spawn(await c.getFFmpegPath(),a,{stdio:["pipe","pipe","pipe","pipe"]});return(0,o.ffmpegLogInitialOutput)(n,d),{cp:d,generator:l(d.stdio[3])}}},5958:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleRebroadcasterClient=t.startParserSession=t.setupActivityTimer=t.parseAudioCodec=t.parseVideoCodec=t.parseResolution=void 0;const s=i(r(7954)),n=i(r(2081)),o=r(2361),a=r(4942),c=r(400),l=r(4921),{mediaManager:d}=s.default;async function u(e){return new Promise(((t,r)=>{e.on("exit",(()=>r(new Error("ffmpeg exited while waiting to parse stream resolution"))));const i=r=>{const s=r.toString(),n=/(([0-9]{2,5})x([0-9]{2,5}))/.exec(s);n&&(e.stdout.removeListener("data",i),e.stderr.removeListener("data",i),t(n))};e.stdout.on("data",i),e.stderr.on("data",i)}))}async function p(e,t){return new Promise(((r,i)=>{e.on("exit",(()=>i(new Error("ffmpeg exited while waiting to parse stream information: "+t))));const s=i=>{const n=i.toString().split("Output ")[0],o=n.lastIndexOf(`${t}: `);if(-1!==o){const i=n.substring(o+t.length+1).trim();let a=i.indexOf(" ");const c=i.indexOf(",");-1!==a&&c<a&&(a=c),-1!==a&&(e.stdout.removeListener("data",s),e.stderr.removeListener("data",s),r(i.substring(0,a)))}};e.stdout.on("data",s),e.stderr.on("data",s)}))}async function h(e){return p(e,"Video")}async function m(e){return p(e,"Audio")}function f(e,t,r,i){let s;let n=Date.now();function o(){n=Date.now()}return i&&(s=setInterval((()=>{Date.now()>n+i&&(clearInterval(s),s=void 0,function(){const r="timeout waiting for data, killing parser session";console.error(r,e),t(new Error(r))}())}),i)),r.once("killed",(()=>clearInterval(s))),o(),{resetActivityTimer:o,clearActivityTimer:function(){clearInterval(s)}}}t.parseResolution=u,t.parseVideoCodec=h,t.parseAudioCodec=m,t.setupActivityTimer=f,t.startParserSession=async function(e,t){const{console:r}=t;let i=!0;const s=new o.EventEmitter;let p,g,v,S;s.on("error",(e=>r.error("rebroadcast error",e)));const y=new Promise((e=>{S=e}));function _(e){i&&(s.emit("killed"),s.emit("error",e||new Error("killed"))),i=!1,S(),(0,l.safeKillFFmpeg)(R)}const b=e.inputArguments.slice(),w=e=>{if(!i)throw e(),new Error("parser session was killed killed before ffmpeg connected");s.on("killed",e)},E=["pipe","pipe","pipe"];let P=3;const T=[];for(const e of Object.keys(t.parsers)){const i=t.parsers[e];if(i.tcpProtocol){const n=await(0,c.listenZeroSingleClient)(),o=new URL(i.tcpProtocol);o.port=n.port.toString(),b.push(...i.outputArguments,o.toString());const{resetActivityTimer:a}=f(e,_,s,t?.timeout);T.push((async()=>{const t=await n.clientPromise;try{w((()=>t.destroy()));for await(const r of i.parse(t,parseInt(v?.[2]),parseInt(v?.[3])))s.emit(e,r),a()}catch(e){r.error("rebroadcast parse error",e),_(e)}}))}else b.push(...i.outputArguments,"pipe:"+P++),E.push("pipe")}b.unshift("-hide_banner"),(0,l.safePrintFFmpegArguments)(r,b);const R=n.default.spawn(await d.getFFmpegPath(),b,{stdio:E});let I;return(0,l.ffmpegLogInitialOutput)(r,R,void 0,t?.storage),R.on("exit",(()=>_(new Error("ffmpeg exited")))),I=Promise.resolve([]),m(R).then((e=>p=e)),u(R).then((e=>v=e)),await h(R).then((e=>g=e)),{start:()=>{for(const e of T)e();let e=0;Object.keys(t.parsers).forEach((async i=>{const n=t.parsers[i];if(!n.parse||n.tcpProtocol)return;const o=R.stdio[3+e];e++;try{const{resetActivityTimer:e}=f(i,_,s,t?.timeout);for await(const t of n.parse(o,parseInt(v?.[2]),parseInt(v?.[3])))s.emit(i,t),e()}catch(e){r.error("rebroadcast parse error",e),_(e)}}))},sdp:I,get inputAudioCodec(){return p},get inputVideoCodec(){return g},get inputVideoResolution(){return{width:parseInt(v?.[2]),height:parseInt(v?.[3])}},get isActive(){return i},kill(e){_(e)},killed:y,negotiateMediaStream:()=>{const t=(0,a.cloneDeep)(e.mediaStreamOptions)||{id:void 0,name:void 0};return t.video||(t.video={}),t.video.codec=g,t.audio=t?.audio?.codec===p?e?.mediaStreamOptions?.audio:{codec:p},t},emit(e,t){return s.emit(e,t),this},on(e,t){return s.on(e,t),this},once(e,t){return s.once(e,t),this},removeListener(e,t){return s.removeListener(e,t),this}}},t.handleRebroadcasterClient=function(e,t){const r=t=>{for(const r of t.chunks)e.write(r);return e.writableLength},i=()=>{const t=n;n=void 0,e.destroy(),t?.()},s={writeData:t=>(t.startStream&&e.write(t.startStream),s.writeData=r,r(t)),destroy:i};let n=t?.connect(s);e.once("close",(()=>{i()})),e.on("error",(e=>t?.console?.log("client stream ended")))}},400:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ListenZeroSingleClientTimeoutError=t.listenZeroSingleClient=t.listenZero=t.bind=t.createBindUdp=t.reserveUdpPort=t.createBindZero=t.bindZero=t.bindUdp=t.closeQuiet=void 0;const s=r(2361),n=i(r(1891));async function o(e,t,r){e.bind(t,r),await(0,s.once)(e,"listening");const i=e.address().port;return{port:i,url:`udp://127.0.0.1:${i}`}}async function a(e){return c(0,e)}async function c(e,t){const r=n.default.createSocket(t||"udp4"),{port:i,url:s}=await o(r,e);return{server:r,port:i,url:s}}t.closeQuiet=async function(e){if(e)try{await new Promise(((t,r)=>{try{e.close(t)}catch(e){r(e)}}))}catch(e){}},t.bindUdp=o,t.bindZero=async function(e){return o(e,0)},t.createBindZero=a,t.reserveUdpPort=async function(){const e=await a();return await new Promise((t=>e.server.close((()=>t(void 0))))),e.port},t.createBindUdp=c,t.bind=async function(e,t){return e.bind(t),await(0,s.once)(e,"listening"),{port:t,url:`udp://127.0.0.1:${t}`}};var l=r(7189);Object.defineProperty(t,"listenZero",{enumerable:!0,get:function(){return l.listenZero}}),Object.defineProperty(t,"listenZeroSingleClient",{enumerable:!0,get:function(){return l.listenZeroSingleClient}}),Object.defineProperty(t,"ListenZeroSingleClientTimeoutError",{enumerable:!0,get:function(){return l.ListenZeroSingleClientTimeoutError}})},4921:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),s(r(1795),t)},2808:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createMapPromiseDebouncer=t.createPromiseDebouncer=t.timeoutFunction=t.timeoutPromise=t.TimeoutError=t.singletonPromise=void 0,t.singletonPromise=function(e,t,r=0){if(e?.promise)return e;const i=t();return e?e.promise=i:e={promise:i,cacheDuration:r},i.finally((()=>setTimeout((()=>e.promise=void 0),e.cacheDuration))),e};class r extends Error{constructor(e){super("Operation Timed Out"),this.promise=e}}t.TimeoutError=r,t.timeoutPromise=function(e,t){return new Promise(((i,s)=>{const n=setTimeout((()=>s(new r(t))),e);t.then((e=>{clearTimeout(n),i(e)})).catch((e=>{clearTimeout(n),s(e)}))}))},t.timeoutFunction=function(e,t){return new Promise(((i,s)=>{let n=!1;const o=t((()=>n)),a=setTimeout((()=>{n=!0,s(new r(o))}),e);o.then((e=>{clearTimeout(a),i(e)})).catch((e=>{clearTimeout(a),s(e)}))}))},t.createPromiseDebouncer=function(){let e;return t=>(e||(e=t().finally((()=>e=void 0))),e)},t.createMapPromiseDebouncer=function(){const e=new Map;return(t,r)=>{const i=JSON.stringify(t);let s=e.get(i);return s||(s=r().finally((()=>e.delete(i))),e.set(i,s)),s}}},6521:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.readString=t.readLine=t.readUntil=t.readLength=t.StreamEndError=t.read16BELengthLoop=void 0;const i=r(2361);t.read16BELengthLoop=async function(e,t){let r;const{skipHeader:s,callback:n}=t,o=t.offset||0,a=t.headerLength||2;let c,l;e.on("error",(e=>r=e));let d=0,u=0;const p=()=>{u++,h()},h=()=>{for(;;){if(d!==u)return;if(c){const t=e.read(l);if(!t)return;n(c,t),c=void 0}else{if(c=e.read(a),!c)return;if(s?.(c,p)){d++,c=void 0;continue}l=c.readUInt16BE(o)}}};throw h(),e.on("readable",h),await(0,i.once)(e,"end"),new Error("stream ended")};class s extends Error{constructor(){super()}}async function n(e,t){if(e.readableEnded||e.destroyed)throw new Error("stream ended");if(!t)return Buffer.alloc(0);{const r=e.read(t);if(r)return r}return new Promise(((r,i)=>{const n=()=>{const s=e.read(t);if(s)return a(),void r(s);(e.readableEnded||e.destroyed)&&i(new Error("stream ended during read"))},o=()=>{a(),i(new s)},a=()=>{e.removeListener("readable",n),e.removeListener("end",o)};e.on("readable",n),e.on("end",o)}))}t.StreamEndError=s,t.readLength=n;const o="\n".charCodeAt(0);async function a(e,t){const r=[];let i=0;for(;;){const s=await n(e,1);if(!s)throw new Error("end of stream");if(s[0]===t)break;r[i++]=s[0]}return Buffer.from(r).toString()}t.readUntil=a,t.readLine=async function(e){return a(e,o)},t.readString=async function(e){let t="";return(e=await e).on("data",(e=>{t+=e.toString()})),e.resume(),await(0,i.once)(e,"end"),t}},7030:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.listenSingleRtspClient=t.RtspServer=t.RtspClient=t.RtspBase=t.RtspStatusError=t.parseSemicolonDelimited=t.getFirstAuthenticateHeader=t.parseHeaders=t.createRtspParser=t.getNaluTypesInNalu=t.getNaluFragmentInformation=t.getNaluTypes=t.findH264NaluTypeInNalu=t.findH264NaluType=t.H264_NAL_TYPE_MTAP32=t.H264_NAL_TYPE_MTAP16=t.H264_NAL_TYPE_FU_B=t.H264_NAL_TYPE_FU_A=t.H264_NAL_TYPE_STAP_B=t.H264_NAL_TYPE_STAP_A=t.H264_NAL_TYPE_PPS=t.H264_NAL_TYPE_SPS=t.H264_NAL_TYPE_SEI=t.H264_NAL_TYPE_IDR=t.H264_NAL_TYPE_RESERVED31=t.H264_NAL_TYPE_RESERVED30=t.H264_NAL_TYPE_RESERVED0=t.writeMessage=t.readBody=t.readMessage=t.RTSP_FRAME_MAGIC=void 0;const a=n(r(6113)),c=r(2361),l=r(5948),d=r(9358),u=o(r(1808)),p=o(r(4404)),h=r(6405),m=r(400),f=r(2808),g=r(6521),v=r(1853),S=r(5045),y=r(7310),_=["realm","nonce"];async function b(e){let t=[];for(;;){let r=await(0,g.readLine)(e);if(r=r.trim(),!r)return t;t.push(r)}}async function w(e,t){const r=parseInt(t["content-length"]);if(r)return(0,g.readLength)(e,r)}function E(e,t,r,i,s){let n=void 0!==t?`${t}\r\n`:"";r&&(i["Content-Length"]=r.length.toString());for(const[e,t]of Object.entries(i))n+=`${e}: ${t}\r\n`;n+="\r\n",e.write(n),s?.log("rtsp outgoing message\n",n),s?.log(),r&&e.write(r)}function P(e,t){if("h264"===e.type)return T(e.chunks[e.chunks.length-1].subarray(12),t)}function T(e,r){const i=31&e[0];if(i===t.H264_NAL_TYPE_STAP_A){let t=1;for(;t<e.length;){const i=e.readUInt16BE(t);t+=2;if((31&e[t])===r)return e.subarray(t,t+i);t+=i}}else if(i===t.H264_NAL_TYPE_FU_A){const t=31&e[1],i=!!(128&e[1]);if(t===r&&i)return e.subarray(1)}else if(i===r)return e}function R(e,r=!1,i=!1){const s=new Set,n=31&e[0];if(n===t.H264_NAL_TYPE_STAP_A){s.add(t.H264_NAL_TYPE_STAP_A);let r=1;for(;r<e.length;){const t=e.readUInt16BE(r);r+=2;const i=31&e[r];s.add(i),r+=t}}else if(n===t.H264_NAL_TYPE_FU_A){s.add(t.H264_NAL_TYPE_FU_A);const n=31&e[1];if(r){!!(128&e[1])&&s.add(n)}else if(i){!!(64&e[1])&&s.add(n)}else s.add(n)}else s.add(n);return s}function I(e){const t={};for(const r of e.slice(1)){const e=r.indexOf(":");let i="";-1!==e&&(i=r.substring(e+1).trim());t[r.substring(0,e).toLowerCase()]=i}return t}function O(e){for(const t of e.slice(1)){const e=t.indexOf(":");let r="";-1!==e&&(r=t.substring(e+1).trim());if("www-authenticate"===t.substring(0,e).toLowerCase())return r}}function A(e){const t={};for(const r of e.split(";")){const[e,i]=r.split("=",2);t[e]=i}return t}t.RTSP_FRAME_MAGIC=36,t.readMessage=b,t.readBody=w,t.writeMessage=E,t.H264_NAL_TYPE_RESERVED0=0,t.H264_NAL_TYPE_RESERVED30=30,t.H264_NAL_TYPE_RESERVED31=31,t.H264_NAL_TYPE_IDR=5,t.H264_NAL_TYPE_SEI=6,t.H264_NAL_TYPE_SPS=7,t.H264_NAL_TYPE_PPS=8,t.H264_NAL_TYPE_STAP_A=24,t.H264_NAL_TYPE_STAP_B=25,t.H264_NAL_TYPE_FU_A=28,t.H264_NAL_TYPE_FU_B=29,t.H264_NAL_TYPE_MTAP16=26,t.H264_NAL_TYPE_MTAP32=27,t.findH264NaluType=P,t.findH264NaluTypeInNalu=T,t.getNaluTypes=function(e){return"h264"!==e.type?new Set:R(e.chunks[e.chunks.length-1].subarray(12))},t.getNaluFragmentInformation=function(e){const r=(31&e[0])===t.H264_NAL_TYPE_FU_A;return{fua:r,fuaStart:r&&!!(128&e[1]),fuaEnd:r&&!!(64&e[1])}},t.getNaluTypesInNalu=R,t.createRtspParser=function(e){let r;return{container:"rtsp",tcpProtocol:"rtsp://127.0.0.1/"+(0,a.randomBytes)(8).toString("hex"),inputArguments:["-rtsp_transport","tcp"],outputArguments:["-rtsp_transport","tcp",...e?.vcodec||[],...e?.acodec||[],"-f","rtsp"],findSyncFrame(e){let r,i={};const s=()=>e.slice(r);for(let s=0;s<e.length;s++){const n=e[s];"h264"===n.type?P(n,t.H264_NAL_TYPE_SPS)&&(r=s):i[n.type]=n}if(void 0!==r)return s();i={};for(let s=0;s<e.length;s++){const n=e[s];"h264"===n.type?P(n,t.H264_NAL_TYPE_IDR)&&(r=s):i[n.type]=n}return void 0!==r?s():void 0},sdp:new Promise((e=>r=e)),async*parse(e,t,i){const s=new D(e);await s.handleSetup(),r(s.sdp);for await(const{type:e,rtcp:r,header:n,packet:o}of s.handleRecord())yield{chunks:[n,o],type:`${r?"rtcp-":""}${e}`,width:t,height:i}}}},t.parseHeaders=I,t.getFirstAuthenticateHeader=O,t.parseSemicolonDelimited=A;class M extends Error{constructor(e){super(`RTSP Error: ${e.line}`),this.status=e}}t.RtspStatusError=M;class x{constructor(){}write(e,t,r){E(this.client,e,r,t,this.console)}async readMessage(){const e=await b(this.client);return this.console?.log("rtsp incoming message\n",e.join("\n")),this.console?.log(),e}}t.RtspBase=x;t.RtspClient=class extends x{constructor(e){super(),this.url=e,this.cseq=0,this.needKeepAlive=!1,this.setupOptions=new Map,this.issuedTeardown=!1,this.hasGetParameter=!0;const t=new y.URL(e),r=parseInt(t.port)||554;e.startsWith("rtsps")?this.client=p.default.connect({rejectUnauthorized:!1,port:r,host:t.hostname}):this.client=u.default.connect(r,t.hostname),this.client.on("error",(e=>{this.console?.log("client error",e)}))}async safeTeardown(){if(!this.issuedTeardown){this.issuedTeardown=!0;try{this.writeTeardown(),await(0,S.sleep)(500)}catch(e){}finally{this.client.destroy()}}}writeRequest(e,t,r,i){t=t||{};let s=this.url;r&&(r.includes("rtsp://")||r.includes("rtsps://")?s=r:s+=(s.endsWith("/")?"":"/")+r);const n=new y.URL(s);n.username="",n.password="";const o=`${e} ${n} RTSP/1.0`,a=this.cseq++;t.CSeq=a.toString(),t["User-Agent"]="Scrypted",this.wwwAuthenticate&&(t.Authorization=this.createAuthorizationHeader(e,new y.URL(s))),this.session&&(t.Session=this.session),this.write(o,t,i)}async handleDataPayload(e){if(e[0]!==t.RTSP_FRAME_MAGIC)throw new Error("RTSP Client received invalid frame magic. This may be a bug in your camera firmware. If this error persists, switch your RTSP Parser to FFmpeg or Scrypted (UDP): "+e.toString());const r=e.readUInt8(1),i=e.readUInt16BE(2),s=await(0,g.readLength)(this.client,i);this.setupOptions.get(r)?.onRtp?.(e,s)}async readDataPayload(){const e=await(0,g.readLength)(this.client,4);return this.handleDataPayload(e)}createBadHeader(e){return new Error("RTSP Client received invalid frame magic. This may be a bug in your camera firmware. If this error persists, switch your RTSP Parser to FFmpeg or Scrypted (UDP): "+e.toString())}async readLoopLegacy(){try{for(;;)this.needKeepAlive&&(this.needKeepAlive=!1,this.hasGetParameter?await this.getParameter():await this.options()),await this.readDataPayload()}catch(e){throw this.client.destroy(e),e}}async readLoop(){const e=new h.Deferred;let r,i,s;const n=async()=>{this.needKeepAlive&&(this.needKeepAlive=!1,this.hasGetParameter?this.writeGetParameter():this.writeOptions());try{for(;;){if(!r){if(r=this.client.read(4),!r)return;if(r[0]!==t.RTSP_FRAME_MAGIC){if("RTSP"!==r.toString())throw this.createBadHeader(r);this.client.unshift(r),r=void 0,this.client.removeListener("readable",n);const e=await super.readMessage();await this.readBody(I(e));this.client.on("readable",n);continue}i=r.readUInt8(1),s=r.readUInt16BE(2)}const e=this.client.read(s);if(!e)return;const o=r;r=void 0;this.setupOptions.get(i)?.onRtp?.(o,e)}}catch(t){e.reject(t),this.client.destroy()}};n(),this.client.on("readable",n),await Promise.all([(0,c.once)(this.client,"end")])}async readMessage(){for(;;){const e=await(0,g.readLength)(this.client,4);if(e[0]!==t.RTSP_FRAME_MAGIC){if("RTSP"===e.toString()){this.client.unshift(e);return await super.readMessage()}throw this.createBadHeader(e)}await this.handleDataPayload(e)}}createAuthorizationHeader(e,t){if(!this.wwwAuthenticate)throw new Error("no WWW-Authenticate found");if(this.wwwAuthenticate.includes("Basic")){return`Basic ${l.BASIC.computeHash(t)}`}const r=(0,d.parseHTTPHeadersQuotedKeyValueSet)(this.wwwAuthenticate,{indexOf:()=>0},_),i=new y.URL(this.url),s=decodeURIComponent(i.username),n=decodeURIComponent(i.password),o=new y.URL(t.toString());o.username="",o.password="";const c=a.default.createHash("md5").update(`${s}:${r.realm}:${n}`).digest("hex"),u=a.default.createHash("md5").update(`${e}:${o}`).digest("hex"),p=a.default.createHash("md5").update(`${c}:${r.nonce}:${u}`).digest("hex"),h={username:s,realm:r.realm,nonce:r.nonce,uri:o.toString(),algorithm:"MD5",response:p};return`Digest ${Object.entries(h).map((([e,t])=>{return`${e}=${t&&(r=t,`"${r.replace(/"/g,'\\"')}"`)}`;var r})).join(", ")}`}async readBody(e){return w(this.client,e)}async request(e,t,r,i,s){this.writeRequest(e,t,r,i);const n=this.requestTimeout?await(0,f.timeoutPromise)(this.requestTimeout,this.readMessage()):await this.readMessage(),o=n[0],[a,c,l]=o.split(" ",3),d=parseInt(c),u=I(n),p={line:o,code:d,version:a,reason:l};if(200!==d&&!u["www-authenticate"])throw new M(p);const h=O(n)||u["www-authenticate"];if(h){if(s)throw new Error("auth failed");return this.wwwAuthenticate=h,this.request(e,t,r,i,!0)}return{headers:u,body:await this.readBody(u),status:p}}async options(){const e=await this.request("OPTIONS",{}),t=e.headers.public;return t&&(this.hasGetParameter=t.toLowerCase().includes("get_parameter")),e}writeOptions(){return this.writeRequest("OPTIONS")}async getParameter(){return this.request("GET_PARAMETER")}writeGetParameter(){return this.writeRequest("GET_PARAMETER")}async describe(e){return this.request("DESCRIBE",{...e||{},Accept:"application/sdp"})}async setup(e){const t="udp"===e.type?"":"/TCP",r="udp"===e.type?"client_port":"interleaved";let i;if("tcp"===e.type)i=e.port;else{if(!e.dgram){const t=await(0,m.createBindZero)();e.dgram=t.server,this.client.on("close",(()=>(0,m.closeQuiet)(t.server)))}i=e.dgram.address().port,e.dgram.on("message",(t=>e.onRtp(void 0,t)))}const s={Transport:`RTP/AVP${t};unicast;${r}=${i}-${i+1}`},n=await this.request("SETUP",s,e.path);let o;if(n.headers.session){const e=A(n.headers.session);let t=parseInt(e.timeout);if(t){let e=setInterval((()=>this.needKeepAlive=!0),1e3*(t-5));this.client.once("close",(()=>clearInterval(e)))}this.session=n.headers.session.split(";")[0]}if(n.headers.transport){const e=n.headers.transport.match(/.*?interleaved=([0-9]+)-([0-9]+)/);if(e){const[t,r,i]=e;r&&i&&(o={begin:parseInt(r),end:parseInt(i)})}}return"tcp"===e.type&&this.setupOptions.set(o?o.begin:i,e),Object.assign({interleaved:o,options:e},n)}async play(e={},t="0.000"){return e.Range=`npt=${t}-`,this.request("PLAY",e)}writePlay(e="0.000"){const t={Range:`npt=${e}-`};return this.writeRequest("PLAY",t)}writeRtpPayload(e,t){return this.client.write(e),this.client.write(Buffer.from(t))}send(e,r){const i=Buffer.alloc(4);return i.writeUInt8(t.RTSP_FRAME_MAGIC,0),i.writeUInt8(r,1),i.writeUInt16BE(e.length,2),this.writeRtpPayload(i,e)}async pause(){return this.request("PAUSE")}async teardown(){try{return await this.request("TEARDOWN")}finally{this.client.destroy()}}writeTeardown(){this.writeRequest("TEARDOWN")}};class D{constructor(e,t,r,i){this.client=e,this.sdp=t,this.udp=r,this.checkRequest=i,this.setupTracks={},this.availableOptions=["DESCRIBE","OPTIONS","PAUSE","PLAY","SETUP","TEARDOWN","ANNOUNCE","RECORD","GET_PARAMETER"],this.session=(0,a.randomBytes)(4).toString("hex"),t&&(t=t.trim()),e instanceof u.default.Socket&&e.setNoDelay(!0)}async handleSetup(e=["play","record","teardown"]){let t=[];for(;;){let r=await(0,g.readLine)(this.client);if(r=r.trim(),r)t.push(r);else{const r=await this.headers(t);if(e.includes(r))return r;t=[]}}}async handlePlayback(){return this.handleSetup()}async handleTeardown(){return this.handleSetup()}async*handleRecord(){for(;;){const e=await(0,g.readLength)(this.client,4);if(e[0]!==t.RTSP_FRAME_MAGIC)throw new Error("RTSP Server expected frame magic but received: "+e.toString());const r=e.readUInt16BE(2),i=await(0,g.readLength)(this.client,r),s=e.readUInt8(1),n=s-s%2,o=Object.values(this.setupTracks).find((e=>e.destination===n));if(!o)throw new Error("RSTP Server received unknown channel: "+s);yield{type:o.codec,rtcp:s%2==1,header:e,packet:i}}}writeRtpPayload(e,t){return this.client.write(e),this.client.write(Buffer.from(t))}send(e,t){const r=Buffer.alloc(4);return r.writeUInt8(36,0),r.writeUInt8(t,1),r.writeUInt16BE(e.length,2),this.writeRtpPayload(r,e)}sendUdp(e,t,r){e.send(r,t,"127.0.0.1")}sendTrack(e,t,r){const i=this.setupTracks[e];return i?"udp"===i.protocol?(this.udp?this.sendUdp(r?i.rtcp:i.rtp,i.destination,t):this.console?.warn("RTSP Server UDP socket not available."),!0):this.send(t,r?i.destination+1:i.destination):(this.console?.warn("RTSP Server track not found:",e),!0)}options(e,t){const r={};r.Public=this.availableOptions.join(", "),this.respond(200,"OK",t,r)}async get_parameter(e,t){this.respond(200,"OK",t,{})}describe(e,t){const r={};r["Content-Base"]=e,r["Content-Type"]="application/sdp",this.respond(200,"OK",t,r,Buffer.from(this.sdp))}setupInterleaved(e,t,r){this.setupTracks[e.control]={control:e.control,protocol:"tcp",destination:t,codec:e.codec}}async setup(e,t){const r={};let i=t.transport;r.Session=this.session;const s=(0,v.parseSdp)(this.sdp).msections.find((t=>e.endsWith(t.control)));if(s){if(i.includes("TCP"))if(this.resolveInterleaved){const[e,t]=this.resolveInterleaved(s);this.setupInterleaved(s,e,t),i=`RTP/AVP/TCP;unicast;interleaved=${e}-${t}`}else{const e=i.match(/.*?interleaved=([0-9]+)-([0-9]+)/);if(e){const t=parseInt(e[1]),r=parseInt(e[2]);this.setupInterleaved(s,t,r)}}else{if(!this.udp)return void this.respond(461,"Unsupported Transport",t,{});const e=i.match(/.*?client_port=([0-9]+)-([0-9]+)/),[r,n,o]=e,a=await(0,m.createBindZero)(),c=await(0,m.createBindUdp)(a.port+1);this.client.on("close",(()=>(0,m.closeQuiet)(a.server))),this.client.on("close",(()=>(0,m.closeQuiet)(c.server))),this.setupTracks[s.control]={control:s.control,protocol:"udp",destination:parseInt(n),codec:s.codec,rtp:a.server,rtcp:c.server},i=i.replace("RTP/AVP/UDP","RTP/AVP").replace("RTP/AVP","RTP/AVP/UDP"),i+=`;server_port=${a.port}-${c.port}`}r.Transport=i,this.respond(200,"OK",t,r)}else this.respond(404,"Not Found",t,r)}play(e,t){const r={},i=Object.values(this.setupTracks).map((t=>`url=${e}/${t.control}`)).join(",");r["RTP-Info"]=i,r.Range="npt=now-",r.Session=this.session,this.respond(200,"OK",t,r)}async announce(e,t){const r=parseInt(t["content-length"]),i=await(0,g.readLength)(this.client,r);this.sdp=i.toString();const s={};s.Session=this.session,this.respond(200,"OK",t,s)}async record(e,t){const r={};r.Session=this.session,this.respond(200,"OK",t,r)}async teardown(e,t){const r={};r.Session=this.session,this.respond(200,"OK",t,r),this.client.destroy()}async headers(e){this.console?.log("request headers",e.join("\n"));let[t,r]=e[0].split(" ",2);t=t.toLowerCase();const i=I(e);if(this.checkRequest){let s;try{s=await this.checkRequest(t,r,i,e)}catch(e){this.console?.error("error checking request",e)}if(!s)throw this.respond(400,"Bad Request",i,{}),this.client.destroy(),new Error("check request failed")}if(this[t]&&this.availableOptions.includes(t.toUpperCase()))return await this[t](r,i),t;this.respond(400,"Bad Request",i,{})}respond(e,t,r,i,s){let n=`RTSP/1.0 ${e} ${t}\r\n`;r.cseq&&(i.CSeq=r.cseq),s&&(i["Content-Length"]=s.length.toString());for(const[e,t]of Object.entries(i))n+=`${e}: ${t}\r\n`;this.console?.log("response headers",n),n+="\r\n",this.client.write(n),s&&(this.client.write(s),this.console?.log("response body",s.toString()))}destroy(){this.client.destroy();for(const e of Object.values(this.setupTracks))(0,m.closeQuiet)(e.rtp),(0,m.closeQuiet)(e.rtcp)}}t.RtspServer=D,t.listenSingleRtspClient=async function(e){const t=e?.pathToken||a.default.randomBytes(8).toString("hex");let{url:r,clientPromise:i,server:s}=await(0,m.listenZeroSingleClient)(e?.hostname);const n="/"+t;r=r.replace("tcp:","rtsp:")+n;const o=i.then((t=>{const r=(e?.createServer||(e=>new D(e)))(t);return r.checkRequest=async(e,t,i,s)=>{r.checkRequest=void 0;return new y.URL(t).pathname===n},r}));return{url:r,rtspServerPromise:o,server:s}}},1853:(e,t)=>{"use strict";function r(e){let t=e.split("\n").map((e=>e.trim()));t=t.filter((e=>!e.includes("a=control:")));let r=0;for(let e=0;e<t.length;e++){t[e].startsWith("m=")&&(t.splice(e+1,0,"a=control:trackID="+r),r++)}return t.join("\r\n")}function i(e,t,r=["recvonly","sendrecv"]){const i=function(e){return("\n"+e).split("\nm=")}(e).filter((e=>e.startsWith(t)));for(const e of i){const t=()=>{const t=e.split("\n").map((e=>e.trim())),r="a=control:",i=t.find((e=>e.startsWith(r)));return{section:"m="+e,trackId:i.substring(r.length)}};for(const i of r)if(e.includes(`a=${i}`))return t();if(r.includes("recvonly")&&!e.includes("sendonly")&&!e.includes("inactive"))return t()}}function s(e){const t=[];for(const r of e.split(" ").slice(3)||[])t.push(parseInt(r));return t}function n(e){const t=e.split(" ");return{type:t[0].substring(2),port:parseInt(t[1]),protocol:t[2],payloadTypes:s(e)}}Object.defineProperty(t,"__esModule",{value:!0}),t.getSpsPps=t.parseSdp=t.parseMSection=t.parseRtpMap=t.parseFmtp=t.parseMLine=t.parseMLinePayloadTypes=t.findTracksByType=t.findTrackByType=t.findFmtp=t.createSdpInput=t.addTrackControls=t.replaceSectionPort=t.replacePorts=void 0,t.replacePorts=function(e,t,r){return e.replace(/c=IN .*/,"c=IN IP4 127.0.0.1").replace(/m=audio \d+/,`m=audio ${t}`).replace(/m=video \d+/,`m=video ${r}`)},t.replaceSectionPort=function(e,t,r){const i=new RegExp(`m=${t} \\d+`);return e.replace(/c=IN .*/,"c=IN IP4 127.0.0.1").replace(i,`m=${t} ${r}`)},t.addTrackControls=r,t.createSdpInput=function(e,t,i){let s=i.replace(/c=IN .*/,"c=IN IP4 127.0.0.1").replace(/m=audio \d+/,`m=audio ${e}`).replace(/m=video \d+/,`m=video ${t}`),n=s.split("\n").map((e=>e.trim()));return n=n.filter((e=>!e.includes("a=rtcp-mux"))).filter((e=>!e.includes("a=candidate"))).filter((e=>!e.includes("a=ice"))),s=n.join("\r\n"),s=r(s),s=s.split("m=").slice(1).map((e=>"m="+e)).join(""),s},t.findFmtp=function(e,t){let r=e.split("\n").map((e=>e.trim()));const i=new RegExp(`a=rtpmap:(\\d+) ${t}`);return r.map((e=>e.match(i))).filter((e=>!!e)).map((e=>{const t=parseInt(e[1]),i=`a=fmtp:${t} `,s=r.find((e=>e.startsWith(i)))?.substring(i.length);return{payloadType:t,fmtp:s}}))},t.findTrackByType=i,t.findTracksByType=function(e,t=["recvonly","sendrecv"]){return{audio:i(e,"audio",t)?.trackId,video:i(e,"video",t)?.trackId}},t.parseMLinePayloadTypes=s,t.parseMLine=n;function o(e){return e.filter((e=>e.startsWith("a=fmtp"))).map((e=>{const t=e.indexOf(" ");if(-1===t)return;const r=e.substring(0,t),i=e.substring(t+1),s=parseInt(r.split(":")[1]);if(!r||!i||Number.isNaN(s))return;const n={};return i.split(";").map((e=>e.trim())).forEach((e=>{const[t,...r]=e.split("=");n[t]=r.join("=")})),{payloadType:s,parameters:n}})).filter((e=>!!e))}function a(e,t){const r=t?.match(/a=rtpmap:([\d]+) (.*?)\/([\d]+)/);let i;return t=t?.toLowerCase(),t?.includes("mpeg4")?i="aac":t?.includes("opus")?i="opus":t?.includes("pcma")?i="pcm_alaw":t?.includes("pcmu")?i="pcm_ulaw":t?.includes("pcm")?i="pcm":t?.includes("h264")?i="h264":t?.includes("h265")?i="h265":t||"audio"!==e||(i="pcm_alaw"),{line:t,codec:i,rawCodec:r?.[2],clock:parseInt(r?.[3]),payloadType:parseInt(r?.[1])}}t.parseFmtp=o,t.parseRtpMap=a;const c="a=control:",l="a=rtpmap:";function d(e){const t=e.find((e=>e.startsWith(c)))?.substring(c.length),r=e.find((e=>e.startsWith(l))),i=n(e[0]);let s=a(i.type,r).codec;const d=e.filter((e=>e.startsWith(l))).map((e=>a(i.type,e)));let u;for(const t of["sendonly","sendrecv","recvonly","inactive"]){if(e.find((e=>e==="a="+t))){u=t;break}}const p={...i,fmtp:o(e),lines:e,rtpmaps:d,contents:e.join("\r\n"),control:t,codec:s,direction:u,toSdp:()=>p.lines.join("\r\n")};return p}t.parseMSection=d,t.parseSdp=function(e){const t=e.split("\n").map((e=>e.trim())),r=[],i=[];let s;for(const e of t)e.startsWith("m=")&&(s&&i.push(s),s=[]),s?s.push(e):r.push(e);s&&i.push(s);const n={header:{lines:r,contents:r.join("\r\n")},msections:i.map(d),toSdp:()=>[...n.header.lines,...n.msections.map((e=>e.lines)).flat()].join("\r\n")};return n},t.getSpsPps=function(e){const t=e?.fmtp?.[0]?.parameters?.["sprop-parameter-sets"]?.split(",");if(2!==t?.length)return{sps:void 0,pps:void 0};const[r,i]=t;return{sps:Buffer.from(r,"base64"),pps:Buffer.from(i,"base64")}}},6219:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SettingsMixinDeviceBase=void 0;const s=r(7954),n=i(r(7954)),{deviceManager:o}=n.default;class a extends s.MixinDeviceBase{constructor(e){super(e),this.settingsGroup=e.group,this.settingsGroupKey=e.groupKey,process.nextTick((()=>o.onMixinEvent(this.id,this,s.ScryptedInterface.Settings,null)))}async getSettings(){const e=this.mixinDeviceInterfaces.includes(s.ScryptedInterface.Settings)?this.mixinDevice.getSettings():void 0,t=this.getMixinSettings(),r=[];try{const t=await e||[];r.push(...t)}catch(e){const t=this.name,i=`${t} Extension settings failed to load.`;this.console.error(i,e),r.push({key:Math.random().toString(),title:t,value:"Settings Error",group:"Errors",description:i,readonly:!0})}try{const e=await t||[];for(const t of e)t.group=t.group||this.settingsGroup,t.key=this.settingsGroupKey+":"+t.key;r.push(...e)}catch(e){const t=o.getDeviceState(this.mixinProviderNativeId).name,i=`${t} Extension settings failed to load.`;this.console.error(i,e),r.push({key:Math.random().toString(),title:t,value:"Settings Error",group:"Errors",description:i,readonly:!0})}return r}async putSetting(e,t){const r=this.settingsGroupKey+":";if(!e?.startsWith(r))return this.mixinDevice.putSetting(e,t);await this.putMixinSetting(e.substring(r.length),t)||o.onMixinEvent(this.id,this,s.ScryptedInterface.Settings,null)}async release(){await o.onMixinEvent(this.id,this,s.ScryptedInterface.Settings,null)}}t.SettingsMixinDeviceBase=a},5045:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||i(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),s(r(9413),t)},8660:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createRawVideoParser=t.PIXEL_FORMAT_RGB24=t.PIXEL_FORMAT_YUV420P=t.createFragmentedMp4Parser=t.parseMp4StreamChunks=t.createMpegTsParser=t.createDgramParser=void 0;const i=r(2361),s=r(7131),n=r(6521);function o(e){return e}async function*a(e){let t,r,i;for await(const s of e)t?r||(r=s):t=s,yield{startStream:i,chunks:[s.header,s.data],type:s.type},t&&r&&!i&&(i=Buffer.concat([t.header,t.data,r.header,r.data]))}t.createDgramParser=function(){return async function*(e,t,r,s){for(;;){const[t]=await(0,i.once)(e,"message");yield{chunks:[t],type:s}}}},t.createMpegTsParser=function(e){return{container:"mpegts",outputArguments:[...e?.vcodec||[],...e?.acodec||[],"-f","mpegts"],parse:(t=188,r=e=>{if(71!=e[0])throw new Error("Invalid sync byte in mpeg-ts packet. Terminating stream.")},async function*(e){let s=[],n=0;for(;;){const o=e.read();if(!o){await(0,i.once)(e,"readable");continue}if(s.push(o),n+=o.length,n<t)continue;const a=Buffer.concat(s);r?.(a);const c=a.length%t,l=a.slice(0,a.length-c),d=a.slice(a.length-c);s=[d],n=d.length,yield{chunks:[l]}}}),findSyncFrame(e){for(let t=0;t<e.length;t++){const r=e[t];for(let i=0;i<r.chunks.length;i++){const s=r.chunks[i];let n=0;for(;n+188<s.length;){const r=s.subarray(n,n+188);if(256==((31&r[1])<<8|r[2])&&32&r[3]&&r[4]>0&&64&r[5])return e.slice(t);n+=188}}}return e}};var t,r},t.parseMp4StreamChunks=a,t.createFragmentedMp4Parser=function(e){return{container:"mp4",outputArguments:[...e?.vcodec||[],...e?.acodec||[],...s.FFMPEG_FRAGMENTED_MP4_OUTPUT_ARGS],async*parse(e){const t=(0,s.parseFragmentedMP4)(e);yield*a(t)},findSyncFrame:o}},t.PIXEL_FORMAT_YUV420P={name:"yuv420p",computeLength:(e,t)=>e*t*1.5},t.PIXEL_FORMAT_RGB24={name:"rgb24",computeLength:(e,t)=>e*t*3},t.createRawVideoParser=function(e){const r=e?.pixelFormat||t.PIXEL_FORMAT_YUV420P;let i;const{size:s,everyNFrames:a}=e;s&&(i=`scale=${s.width}:${s.height}`),a&&a>1&&(i?i+=",":i="",i+=`select=not(mod(n\\,${a}))`);const c=[];return e.size&&c.push("-s",`${e.size.width}x${e.size.height}`),c.push("-pix_fmt",r.name),{inputArguments:c,container:"rawvideo",outputArguments:["-s",`${e.size.width}x${e.size.height}`,"-an","-vcodec","rawvideo","-pix_fmt",r.name,"-f","rawvideo"],async*parse(e,t,i){if(t=s?.width||t,i=s?.height||i,!t||!i)throw new Error("error parsing rawvideo, unknown width and height");const o=r.computeLength(t,i);for(;;){const r=await(0,n.readLength)(e,o);yield{chunks:[r],width:t,height:i}}},findSyncFrame:o}}},5305:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FileRtspServer=void 0;const s=r(6405),n=r(7030),o=i(r(7147));class a extends n.RtspServer{constructor(e,t,r){super(e,t,void 0,r),this.segmentBytesWritten=0,this.client.on("close",(()=>{this.writeStream&&this.writeConsole?.log("RTSP WRITE client closed."),this.cleanup()})),this.availableOptions.push("WRITE","WRITESIZE")}cleanup(){const e=this.writeStream;e&&(this.writeStream=void 0,e?.end((()=>e?.destroy())))}async write(e,t){const r=t["x-scrypted-rtsp-file"];if(!r)return this.respond(400,"Bad Request",t,{});const i=t["x-scrypted-rtsp-file-truncate"];let n;if(i)try{const e=new s.Deferred;o.default.open(i,"w",((t,r)=>{t?e.reject(t):e.resolve(r)}));const t=await e.promise;try{await o.default.promises.rename(i,r),n=o.default.createWriteStream(void 0,{fd:t})}catch(e){throw e}}catch(e){this.writeConsole?.error("RTSP WRITE error during truncate file",i,e)}this.cleanup(),this.segmentBytesWritten=0,this.writeStream=n||o.default.createWriteStream(r),this.writeStream.on("error",(e=>{this.writeConsole?.error("RTSP WRITE error",e)})),this.respond(200,"OK",t,{})}writesize(e,t){this.respond(200,"OK",t,{"x-scrypted-rtsp-file-size":this.segmentBytesWritten.toString()})}writeRtpPayload(e,t){return this.writeStream?(this.segmentBytesWritten+=e.length+t.length,this.writeStream.write(e),this.writeStream.write(t)):super.writeRtpPayload(e,t)}}t.FileRtspServer=a},7352:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getUrlLocalAdresses=void 0;const s=i(r(7954));t.getUrlLocalAdresses=async function(e,t){let r;try{const e=await s.default.endpointManager.getLocalAddresses();if(e){const[i]=e;if(i){const e=new URL(t);e.hostname=i,t=e.toString()}r=e.map((e=>{const r=new URL(t);return r.hostname=e,r.toString()}))}}catch(t){e.warn("Error determining external addresses. Is Scrypted Server Address configured?",t)}return r}},6360:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.fork=t.RebroadcastPlugin=void 0;const a=r(7817),c=r(7488),l=r(9934),d=r(5958),u=r(400),p=r(6521),h=r(7030),m=r(1853),f=r(6219),g=r(5045),v=r(8660),S=n(r(7954)),y=r(8202),_=o(r(6113)),b=r(2361),w=o(r(1808)),E=o(r(1249)),P=r(5305),T=r(7352),R=r(1514),I=r(8339),O=r(7662),A=r(2977),M=r(1459),{mediaManager:x,log:D,systemManager:C,deviceManager:N}=S.default,L="Default",k="AAC or No Audio",$=`${k} (Copy)`,F="Compatible Audio",j="Other Audio",B=["aac","mp3","mp2","opus"],H="-fflags +genpts",U="Scrypted (TCP)",V="Scrypted (UDP)",G="FFmpeg (TCP)",q="FFmpeg (UDP)",K="Default",W=[k,F,j],Y=["mpegts","mp4","rtsp"];function X(e){return e.fuab||e.mtap16||e.mtap32||e.sei||e.stapb||e.reserved0||e.reserved30||e.reserved31}class z{constructor(e,t,r){this.mixin=e,this.advertisedMediaStreamOptions=t,this.stopInactive=r,this.prebuffers={mp4:[],mpegts:[],rtsp:[]},this.usingScryptedParser=!1,this.usingScryptedUdpParser=!1,this.audioDisabled=!1,this.activeClients=0,this.storage=e.storage,this.console=e.console,this.mixinDevice=e.mixinDevice,this.audioConfigurationKey="audioConfiguration-"+this.streamId,this.ffmpegInputArgumentsKey="ffmpegInputArguments-"+this.streamId,this.rebroadcastModeKey="rebroadcastMode-"+this.streamId,this.lastDetectedAudioCodecKey="lastDetectedAudioCodec-"+this.streamId,this.lastH264ProbeKey="lastH264Probe-"+this.streamId,this.rtspParserKey="rtspParser-"+this.streamId;const i="rtspServerPathKey-"+this.streamId,s="rtspServerMutedPathKey-"+this.streamId;this.rtspServerPath=this.storage.getItem(i),this.rtspServerPath||(this.rtspServerPath=_.default.randomBytes(8).toString("hex"),this.storage.setItem(i,this.rtspServerPath)),this.rtspServerMutedPath=this.storage.getItem(s),this.rtspServerMutedPath||(this.rtspServerMutedPath=_.default.randomBytes(8).toString("hex"),this.storage.setItem(s,this.rtspServerMutedPath))}get canPrebuffer(){return"rawvideo"!==this.advertisedMediaStreamOptions.container&&"ffmpeg"!==this.advertisedMediaStreamOptions.container}getLastH264Probe(){const e=this.storage.getItem(this.lastH264ProbeKey);if(!e)return{};try{return JSON.parse(e)}catch(e){return{}}}getLastH264Oddities(){return X(this.getLastH264Probe())}getDetectedIdrInterval(){const e=[];if(this.prebuffers.mp4.length){let t;for(const r of this.prebuffers.mp4)"mdat"===r.type&&(t&&e.push(r.time-t),t=r.time)}else if(this.prebuffers.rtsp.length){let t;for(const r of this.prebuffers.rtsp)(0,h.findH264NaluType)(r,h.H264_NAL_TYPE_IDR)&&(t&&e.push(r.time-t),t=r.time)}if(!e.length)return;return e.reduce(((e,t)=>e+t),0)/e.length}get streamId(){return this.advertisedMediaStreamOptions.id}get streamName(){return this.advertisedMediaStreamOptions.name||`Stream ${this.streamId}`}clearPrebuffers(){for(const e of Y)this.prebuffers[e]=[]}release(){this.clearPrebuffers(),this.parserSessionPromise?.then((e=>{this.console.log("prebuffer session released"),e.kill(new Error("rebroadcast disabled")),this.clearPrebuffers()}))}ensurePrebufferSession(){this.parserSessionPromise||this.mixin.released||(this.console.log(this.streamName,"prebuffer session started"),this.parserSessionPromise=this.startPrebufferSession(),this.parserSessionPromise.catch((e=>this.parserSessionPromise=void 0)),this.parserSessionPromise.then((e=>e.killed.finally((()=>this.parserSessionPromise=void 0)))))}getAudioConfig(){let e=this.storage.getItem(this.audioConfigurationKey)||"";W.find((t=>e.startsWith(t)))||(e="");const t=-1!==e.indexOf(k),r=-1!==e.indexOf(F),i=-1!==e.indexOf(j);return{isUsingDefaultAudioConfig:!(t||r||i),aacAudio:t,compatibleAudio:r,reencodeAudio:i}}canUseRtspParser(e){return e?.container?.startsWith("rtsp")}getParser(e,t){let r;const i=this.storage.getItem(this.rtspParserKey);return this.canUseRtspParser(t)?(i===G&&(r=G),i===q&&(r=q),e&&!r&&(i&&i!==K||(r=U),i===U&&(r=U),i===V&&(r=V)),r||(r=G)):r=K,{parser:r,isDefault:!i||"Default"===i}}getRebroadcastContainer(){let e=this.storage.getItem(this.rebroadcastModeKey)||"Default";"Default"===e&&(e="RTSP");const t=e?.startsWith("RTSP");return{rtspMode:e?.startsWith("RTSP"),muxingMp4:!t}}async getMixinSettings(){const e=[],t=this.parserSession;let r=0,i=0;const{muxingMp4:s,rtspMode:n}=this.getRebroadcastContainer();for(const e of s?this.prebuffers.mp4:this.prebuffers.rtsp){i=i||e.time;for(const t of e.chunks)r+=t.byteLength}const o=Date.now()-i,a=Math.round(r/o*8),c="Streams",l=`Stream: ${this.streamName}`;e.push({title:"Rebroadcast Container",group:c,subgroup:l,description:"The container format to use when rebroadcasting. The default mode for this camera is RTSP.",placeholder:"RTSP",choices:[K,"MPEG-TS","RTSP"],key:this.rebroadcastModeKey,value:this.storage.getItem(this.rebroadcastModeKey)||K});const d=()=>{e.push({title:"Audio Codec Transcoding",group:c,subgroup:l,description:"Configuring your camera to output Opus, PCM, or AAC is recommended.",type:"string",key:this.audioConfigurationKey,value:this.storage.getItem(this.audioConfigurationKey)||L,choices:[L,$,"Compatible Audio (Copy)","Other Audio (Transcode)"]})},u=()=>{e.push({title:"FFmpeg Input Arguments Prefix",group:c,subgroup:l,description:"Optional/Advanced: Additional input arguments to pass to the ffmpeg command. These will be placed before the input arguments.",key:this.ffmpegInputArgumentsKey,value:this.storage.getItem(this.ffmpegInputArgumentsKey),placeholder:H,choices:[H,"-use_wallclock_as_timestamps 1","-v verbose"],combobox:!0})};let p=s;if(this.canUseRtspParser(this.advertisedMediaStreamOptions)){const t=n,r=t&&!this.getLastH264Oddities()?U:G,i=t?[U,V]:[],s=this.storage.getItem(this.rtspParserKey)||K;e.push({key:this.rtspParserKey,group:c,subgroup:l,title:"RTSP Parser",description:`The RTSP Parser used to read the stream. The default is "${r}" for this container.`,value:s,choices:[K,...i,G,q]}),(s===K?r:s).includes("Scrypted")||(p=!0)}s&&d(),p&&u();const h=()=>{e.push({key:"detectedOddities",group:c,subgroup:l,title:"Detected H264 Oddities",readonly:!0,value:JSON.stringify(this.getLastH264Probe()),description:"Cameras with oddities in the H264 video stream may not function correctly with Scrypted RTSP Parsers or Senders."})};if(t){const r=t.inputVideoResolution?.width&&t.inputVideoResolution?.height?`${t.inputVideoResolution?.width}x${t.inputVideoResolution?.height}`:"unknown",i=this.getDetectedIdrInterval();e.push({key:"detectedResolution",group:c,subgroup:l,title:"Detected Resolution and Bitrate",readonly:!0,value:`${r} @ ${a||"unknown"} Kb/s`,description:"Configuring your camera to 1920x1080, 2000Kb/S, Variable Bit Rate, is recommended."},{key:"detectedCodec",group:c,subgroup:l,title:"Detected Video/Audio Codecs",readonly:!0,value:(t?.inputVideoCodec?.toString()||"unknown")+"/"+(t?.inputAudioCodec?.toString()||"unknown"),description:"Configuring your camera to H264 video and Opus, PCM, or AAC audio is recommended."},{key:"detectedKeyframe",group:c,subgroup:l,title:"Detected Keyframe Interval",description:"Configuring your camera to 4 seconds is recommended (IDR aka Frame Interval = FPS * 4 seconds).",readonly:!0,value:(i||0)/1e3||"unknown"}),h()}else e.push({title:"Status",group:c,subgroup:l,key:"status",description:"Rebroadcast is currently idle and will be started automatically on demand.",value:"Idle",readonly:!0}),h();return n&&(e.push({group:c,subgroup:l,key:"rtspRebroadcastUrl",title:"RTSP Rebroadcast Url",description:"The RTSP URL of the rebroadcast stream. Substitute localhost as appropriate.",readonly:!0,value:`rtsp://localhost:${this.mixin.streamSettings.storageSettings.values.rebroadcastPort}/${this.rtspServerPath}`}),e.push({group:c,subgroup:l,key:"rtspRebroadcastMutedUrl",title:"RTSP Rebroadcast Url (Muted)",description:"The RTSP URL of the muted rebroadcast stream. Substitute localhost as appropriate.",readonly:!0,value:`rtsp://localhost:${this.mixin.streamSettings.storageSettings.values.rebroadcastPort}/${this.rtspServerMutedPath}`})),e}async startPrebufferSession(){let e;this.clearPrebuffers();try{e=(await this.mixinDevice.getVideoStreamOptions()).find((e=>e.id===this.streamId))}catch(e){}const t=null===e?.audio,r=e?.audio?.codec,{isUsingDefaultAudioConfig:i,aacAudio:s,compatibleAudio:n,reencodeAudio:o}=this.getAudioConfig(),{rtspMode:a,muxingMp4:c}=this.getRebroadcastContainer();let l=this.storage.getItem(this.lastDetectedAudioCodecKey)||void 0;"null"===l&&(l=null);let u=!1;c&&!t&&!r&&i&&void 0===l&&(this.console.warn("Camera did not report an audio codec, muting the audio stream and probing the codec."),u=!0);const p=void 0===l?r?.toLowerCase():l?.toLowerCase(),m=!B.includes(p);!c||u||!1===e?.userConfigurable||t||m&&(i&&D.a(`${this.mixin.name} is using the ${p} audio codec. Configuring your Camera to use Opus, PCM, or AAC audio is recommended. If this is not possible, Select 'Transcode Audio' in the camera stream's Rebroadcast settings to suppress this alert.`),this.console.warn("Configure your camera to output Opus, PCM, or AAC audio. Suboptimal audio codec in use:",p));const f=["-bsf:a","aac_adtstoasc"],g=[];let y;this.audioDisabled=!1;const _=null===l;let b=!1;if(c&&!u&&i&&m&&(!1===e?.userConfigurable?this.console.log("camera reports it is not user configurable. transcoding due to incompatible codec",p):this.console.log("camera audio transcoding due to incompatible codec. configure the camera to use a compatible codec if possible."),b=!0),t||u)y=["-an"],this.audioDisabled=!0;else if(o||b)y=["-bsf:a","aac_adtstoasc","-acodec","aac","-ar","32k","-b:a","32k","-ac","1","-profile:a","aac_low","-flags","+global_header"];else if(s||_)y=["-acodec","copy"],y.push(...f);else if(n)y=["-acodec","copy"],y.push(...g);else{y=["-acodec","copy"];const e="aac"===p?f:g;y.push(...e)}const w=["-vcodec","copy"],E={console:this.console,timeout:6e4,parsers:{}};if(this.parsers=E.parsers,this.console.log("rebroadcast mode:",a?"rtsp":"mpegts"),a){const e=(0,h.createRtspParser)({vcodec:w,acodec:t?y:["-acodec","copy"]});this.sdp=e.sdp,E.parsers.rtsp=e}else E.parsers.mpegts=(0,v.createMpegTsParser)({vcodec:w,acodec:y});c&&(E.parsers.mp4=(0,v.createFragmentedMp4Parser)({vcodec:w,acodec:y}));const P=await this.mixinDevice.getVideoStream(e),T="x-scrypted/x-rfc4571"===P.mimeType;let R,A;this.storage.removeItem(this.lastDetectedAudioCodecKey),this.usingScryptedParser=!1;const M=this.getLastH264Oddities();if(a&&T){this.usingScryptedParser=!0,this.console.log("bypassing ffmpeg: using scrypted rfc4571 parser");const e=await x.convertMediaObjectToJSON(P,"x-scrypted/x-rfc4571"),{url:t,sdp:r,mediaStreamOptions:i}=e;R=(0,I.startRFC4571Parser)(this.console,(0,I.connectRFC4571Parser)(t),r,i,E),this.sdp=R.sdp.then((e=>Buffer.concat(e).toString()))}else{const e=await x.convertMediaObjectToBuffer(P,S.ScryptedMimeTypes.FFmpegInput),r=JSON.parse(e.toString());A=r.mediaStreamOptions||this.advertisedMediaStreamOptions;let{parser:i,isDefault:s}=this.getParser(a,A);if(this.usingScryptedParser=i===U||i===V,this.usingScryptedUdpParser=i===V,s&&this.usingScryptedParser&&M&&!this.stopInactive&&"scrypted"!==A.tool&&(this.console.warn("H264 oddities were detected in prebuffered video stream, the Default Scrypted RTSP Parser will not be used. Falling back to FFmpeg. This can be overriden by setting the RTSP Parser to Scrypted."),this.usingScryptedParser=!1,i=G),this.usingScryptedParser)R=await(0,O.startRtspSession)(this.console,r.url,r.mediaStreamOptions,{useUdp:i===V,audioSoftMuted:t,rtspRequestTimeout:1e4}),this.sdp=R.sdp.then((e=>Buffer.concat(e).toString()));else{i===q?r.inputArguments=["-rtsp_transport","udp","-i",r.url]:i===G&&(r.inputArguments=["-rtsp_transport","tcp","-i",r.url]);const e=this.storage.getItem(this.ffmpegInputArgumentsKey)||H;r.inputArguments.unshift(...e.split(" ")),R=await(0,d.startParserSession)(r,E)}}if(this.usingScryptedParser){const e={};let t=!1;const r=r=>{if("h264"!==r.type)return;const s=(0,h.getNaluTypes)(r);e.fuab||=s.has(h.H264_NAL_TYPE_FU_B),e.stapb||=s.has(h.H264_NAL_TYPE_STAP_B),e.mtap16||=s.has(h.H264_NAL_TYPE_MTAP16),e.mtap32||=s.has(h.H264_NAL_TYPE_MTAP32),e.sei||=s.has(h.H264_NAL_TYPE_SEI),e.reserved0||=s.has(h.H264_NAL_TYPE_RESERVED0),e.reserved30||=s.has(h.H264_NAL_TYPE_RESERVED30),e.reserved31||=s.has(h.H264_NAL_TYPE_RESERVED31);if(X(e)&&!t){t=!0;let{isDefault:r}=this.getParser(a,A);if(this.console.warn("H264 oddity detected."),!r)return void this.console.warn("If there are issues streaming, consider using the Default parser.");if("scrypted"===A.tool)return void this.console.warn('Stream tool is marked safe as "scrypted", ignoring oddity. If there are issues streaming, consider switching to FFmpeg parser.');if(!this.stopInactive)return this.console.warn("Oddity in prebuffered stream. Restarting rebroadcast to use FFmpeg instead."),R.kill(new Error("restarting due to H264 oddity detection")),this.storage.setItem(this.lastH264ProbeKey,JSON.stringify(e)),i(),void this.startPrebufferSession()}},i=()=>R.removeListener("rtsp",r);R.killed.finally((()=>clearTimeout(s))),R.on("rtsp",r);const s=setTimeout((()=>{i(),this.storage.setItem(this.lastH264ProbeKey,JSON.stringify(e))}),M?6e4:1e4)}!t&&r&&void 0!==R.inputAudioCodec&&R.inputAudioCodec!==r&&this.console.warn("Audio codec plugin reported vs detected mismatch",r,l);const C=e?.video?.codec;if(C&&void 0!==R.inputVideoCodec&&R.inputVideoCodec!==C&&this.console.warn("Video codec plugin reported vs detected mismatch",C,R.inputVideoCodec),R.inputAudioCodec?B.includes(R.inputAudioCodec?.toLowerCase())?this.console.log("Detected audio codec is mp4/mpegts compatible.",R.inputAudioCodec):this.console.log("Detected audio codec is not mp4/mpegts compatible.",R.inputAudioCodec):this.console.log("No audio stream detected."),this.storage.setItem(this.lastDetectedAudioCodecKey,R.inputAudioCodec||"null"),"h264"!==R.inputVideoCodec&&this.console.error("Video codec is not h264. If there are errors, try changing your camera's encoder output."),u)return this.console.warn("Audio probe complete, ending rebroadcast session and restarting with detected codecs."),R.kill(new Error("audio probe completed, restarting")),this.startPrebufferSession();if(this.parserSession=R,R.killed.finally((()=>{this.parserSession===R&&(this.parserSession=void 0)})),R.killed.finally((()=>clearTimeout(this.inactivityTimeout))),N.onMixinEvent(this.mixin.id,this.mixin,S.ScryptedInterface.Settings,void 0),A?.refreshAt){let e,t=A;const r=async()=>{if(!R.isActive)return;const e=await this.mixinDevice.getVideoStream(t),r=await x.convertMediaObjectToBuffer(e,S.ScryptedMimeTypes.FFmpegInput),s=JSON.parse(r.toString());t=s.mediaStreamOptions,i(t)},i=t=>{const i=t.refreshAt-Date.now()-3e4;this.console.log("refreshing media stream in",i),e=setTimeout(r,i)};i(t),R.killed.finally((()=>clearTimeout(e)))}for(const e of Y){let t=0,r=this.prebuffers[e];R.on(e,(i=>{const s=Date.now();for(i.time=s,r.push(i);r.length&&r[0].time<s-1e4;)r.shift(),t++;t>1e5&&(r=r.slice(),this.prebuffers[e]=r,t=0)}))}return R.start(),R}printActiveClients(){this.console.log(this.streamName,"active rebroadcast clients:",this.activeClients)}inactivityCheck(e,t){this.activeClients||this.stopInactive&&(this.inactivityTimeout&&!t||(clearTimeout(this.inactivityTimeout),this.inactivityTimeout=setTimeout((()=>{this.inactivityTimeout=void 0,this.activeClients?this.console.log("inactivity timeout found active clients."):(this.console.log(this.streamName,"terminating rebroadcast due to inactivity"),e.kill(new Error("stream inactivity")))}),1e4)))}async handleRebroadcasterClient(e){const{isActiveClient:t,container:r,session:i,socketPromise:s,requestedPrebuffer:n}=e;let o;this.console.log("sending prebuffer",n);try{o=await s}catch(e){return this.inactivityCheck(i,!1),void(e instanceof u.ListenZeroSingleClientTimeoutError?this.console.warn("client connection timed out"):this.console.error("client connection error",e))}t&&(this.activeClients++,this.printActiveClients()),o.once("close",(()=>{t&&(this.activeClients--,this.printActiveClients()),this.inactivityCheck(i,t)})),(0,d.handleRebroadcasterClient)(o,{connect:t=>{const s=Date.now(),o=(r,i)=>{if(e.filter&&!(r=e.filter(r,i)))return;t.writeData(r)>1e8&&(this.console.log("more than 100MB has been buffered, did downstream die? killing connection.",this.streamName),a())},a=()=>{i.removeListener(r,o),i.removeListener("killed",a),t.destroy()};i.on(r,o),i.once("killed",a);const c=this.prebuffers[r];if("rtsp"!==r||!e.findSyncFrame||this.getLastH264Oddities())for(const e of c)e.time<s-n||o(e,!0);else{const e=this.parsers[r],t=c.filter((e=>e.time>=s-n));let i=e.findSyncFrame(t);i?this.console.log("Found sync frame in rtsp prebuffer."):(this.console.warn("Unable to find sync frame in rtsp prebuffer."),i=[]);for(const e of i)o(e,!0)}return a}})}async getVideoStream(e,t){if(!1===t?.refresh&&!this.parserSessionPromise)throw new Error("Stream is currently unavailable and will not be started for this request. RequestMediaStreamOptions.refresh === false");const r=!this.parserSessionPromise;this.ensurePrebufferSession();const i=await this.parserSessionPromise;let s=t?.prebuffer;if(null==s||r){const e="remote"===t?.destination?2e3:4e3;s=Math.min(e,this.getDetectedIdrInterval()||e)}const{rtspMode:n,muxingMp4:o}=this.getRebroadcastContainer(),a=n?"rtsp":"mpegts";let c=this.parsers[t?.container]?t?.container:a;const l=i.negotiateMediaStream(t);let d,p,f,g,v=await this.sdp;!l.video?.h264Info&&this.usingScryptedParser&&(l.video||={},l.video.h264Info=this.getLastH264Probe());let S=!1;const y=new Map,_=new Map;let b;if("rtsp"===c){const e=(0,m.parseSdp)(v),r=e.msections.find((e=>e.codec&&e.codec===l.video?.codec))||e.msections.find((e=>"video"===e.type));let s=e.msections.find((e=>e.codec&&e.codec===l.audio?.codec))||e.msections.find((e=>"audio"===e.type));null===l.audio&&(s=void 0),e.msections=e.msections.filter((e=>e===r||e===s));const n=void 0===t?.prebuffer,o=e.msections.find((e=>"video"===e.type))?.codec;v=e.toSdp(),g=(e,t)=>{if(t&&n&&e.type!==o)return;const r=y.get(e.type);if(S){if(void 0===r)return}else{if(null==r){const t=_.get(e.type);return void(t&&b.sendTrack(t.control,e.chunks[1],e.type.startsWith("rtcp-")))}const t=e.chunks.slice(),i=Buffer.from(t[0]);i.writeUInt8(r,1),t[0]=i,e={startStream:e.startStream,chunks:t}}if(!b.writeStream)return e;b.writeRtpPayload(e.chunks[0],e.chunks[1])};const a="internal"===t?.route?void 0:"0.0.0.0",c=await(0,h.listenSingleRtspClient)({hostname:a,createServer:e=>(v=(0,m.addTrackControls)(v),b=new P.FileRtspServer(e,v),b.writeConsole=this.console,b)});d=c.rtspServerPromise.then((async e=>{if(i.parserSpecific){const t=i.parserSpecific;e.resolveInterleaved=e=>{const r=t.interleaved.get(e.codec);return[r,r+1]}}await e.handlePlayback(),e.handleTeardown().catch((()=>{})).finally((()=>e.client.destroy()));for(const t of Object.values(e.setupTracks))"udp"!==t.protocol?(y.set(t.codec,t.destination),y.set(`rtcp-${t.codec}`,t.destination+1)):(_.set(t.codec,t),_.set(`rtcp-${t.codec}`,t));return S=i.parserSpecific&&0===_.size,e.client})),p=c.url,a&&(f=await(0,T.getUrlLocalAdresses)(this.console,p))}else{const e=await(0,u.listenZeroSingleClient)();d=e.clientPromise,p=e.url}l.sdp=v;const w=!1!==t?.refresh;this.handleRebroadcasterClient({findSyncFrame:e,isActiveClient:w,container:c,requestedPrebuffer:s,socketPromise:d,session:i,filter:g}),l.prebuffer=s;const{reencodeAudio:E}=this.getAudioConfig();this.audioDisabled?l.audio=null:E&&o&&(l.audio={codec:"aac",encoder:"aac",profile:"aac_low"}),i.inputVideoResolution?.width&&i.inputVideoResolution?.height&&l.video&&Object.assign(l.video,i.inputVideoResolution);const R=Date.now();let I=0;const O=this.prebuffers[c];for(const e of O)if(!(e.time<R-s))for(const t of e.chunks)I+=t.length;l.prebufferBytes=I;const A=["-analyzeduration","0","-probesize",Math.max(5e5,I).toString()];this.usingScryptedUdpParser||A.push("-reorder_queue_size","0");return{url:p,urls:f,container:c,inputArguments:[...A,...this.parsers[c].inputArguments||[],"-f",this.parsers[c].container,"-i",p],mediaStreamOptions:l}}}class Z extends f.SettingsMixinDeviceBase{constructor(e,t){super(t),this.getTranscodeStorageSettings=e,this.released=!1,this.sessions=new Map,this.streamSettings=(0,A.createStreamSettings)(this),this.delayStart(),this.startRtspServer(),this.settingsListener=C.listenDevice(this.id,S.ScryptedInterface.Settings,(()=>this.ensurePrebufferSessions()))}startRtspServer(){(0,u.closeQuiet)(this.rtspServer),this.rtspServer=new w.default.Server((async e=>{let t;this.console.log("external rtsp client",e.localAddress,e.localPort);const r=new h.RtspServer(e,void 0,!1,(async(e,i,s,n)=>{r.checkRequest=void 0;const o=new URL(i);for(const e of this.sessions.values()){if(o.pathname==="/"+e.rtspServerPath)return r.console=e.console,t=e,t.ensurePrebufferSession(),await t.parserSessionPromise,r.sdp=await t.sdp,!0;if(o.pathname==="/"+e.rtspServerMutedPath){r.console=e.console,t=e,t.ensurePrebufferSession(),await t.parserSessionPromise;const i=(0,m.parseSdp)(await t.sdp);return i.msections=i.msections.filter((e=>"video"===e.type)),r.sdp=i.toSdp(),!0}}return!1}));this.console.log("RTSP Rebroadcast connection started."),r.console=this.console;try{await r.handlePlayback();const i=new Map;for(const[e,t]of Object.entries(r.setupTracks))i.set(t.codec,e);const s=await t.parserSessionPromise,n=Math.max(4e3,t.getDetectedIdrInterval()||4e3);t.handleRebroadcasterClient({findSyncFrame:!0,isActiveClient:!0,container:"rtsp",session:s,socketPromise:Promise.resolve(e),requestedPrebuffer:n,filter:(e,t)=>{const s=i.get(e.type);s&&r.sendTrack(s,e.chunks[1],!1)}}),await r.handleTeardown()}catch(t){e.destroy()}this.console.log("RTSP Rebroadcast connection finished.")})),this.rtspServer.listen(this.streamSettings.storageSettings.values.rebroadcastPort||0),(0,b.once)(this.rtspServer,"listening").then((()=>{const e=this.rtspServer.address().port;this.streamSettings.storageSettings.values.rebroadcastPort=e}))}delayStart(){this.console.log("prebuffer sessions starting in 5 seconds"),setTimeout((()=>this.ensurePrebufferSessions()),5e3)}async getVideoStream(e){if("direct"===e?.route)return this.mixinDevice.getVideoStream(e);await this.ensurePrebufferSessions();let t,r,i,s=e?.id;this.sessions.has(s)||(s=void 0);const n=this.mixins?.includes((0,M.getTranscodeMixinProviderId)()),o=await this.mixinDevice.getVideoStreamOptions();let a;const c=await this.getTranscodeStorageSettings(),d=2e6,u=512e3;if(!s){switch(e?.destination){case"medium-resolution":case"remote":a=this.streamSettings.getRemoteStream(o),i=c.remoteStreamingBitrate;break;case"low-resolution":a=this.streamSettings.getLowResolutionStream(o),i=u;break;case"local-recorder":a=this.streamSettings.getRecordingStream(o),i=d;break;case"remote-recorder":a=this.streamSettings.getRemoteRecordingStream(o),i=d;break;case"local":a=this.streamSettings.getDefaultStream(o),i=d;break;default:const t=e?.video?.width,r=e?.video?.height,s=Math.max(t,r);s?s>1280?(a=this.streamSettings.getDefaultStream(o),i=d):s>720?(a=this.streamSettings.getRemoteStream(o),i=c.remoteStreamingBitrate):(a=this.streamSettings.getLowResolutionStream(o),i=u):(a=this.streamSettings.getDefaultStream(o),i=d)}s=a.stream.id,this.console.log("Selected stream",a.stream.name),n&&this.streamSettings.storageSettings.values.transcodeStreams?.includes(a.title)&&(t=c.h264EncoderArguments?.split(" "),this.streamSettings.storageSettings.values.videoFilterArguments&&(r=this.streamSettings.storageSettings.values.videoFilterArguments))}let p,h=this.sessions.get(s);if(h.canPrebuffer||(this.console.log("Source container can not be prebuffered. Using a direct media stream."),h=void 0),h){const t=!(n||e?.container&&"rtsp"!==e?.container||"ffmpeg"===e?.tool);p=await h.getVideoStream(t,e)}else{const t=await this.mixinDevice.getVideoStream(e);if(!n)return t;p=await x.convertMediaObjectToJSON(t,S.ScryptedMimeTypes.FFmpegInput)}return p.h264EncoderArguments=t,p.destinationVideoBitrate=i,n&&this.streamSettings.storageSettings.values.missingCodecParameters&&(p.mediaStreamOptions||(p.mediaStreamOptions={id:s}),p.mediaStreamOptions.oobCodecParameters=!0),p.h264FilterArguments&&r?(0,l.addVideoFilterArguments)(p.h264FilterArguments,r):r&&(p.h264FilterArguments=["-filter_complex",r]),n&&(p.videoDecoderArguments=this.streamSettings.storageSettings.values.videoDecoderArguments?.split(" ")),x.createFFmpegMediaObject(p,{sourceId:this.id})}async ensurePrebufferSessions(){const e=await this.mixinDevice.getVideoStreamOptions(),t=this.getPrebufferedStreams(e),r=t?t.map((e=>e.id)):[void 0],i=e?.map((e=>e.id))||[void 0];if("true"!==this.storage.getItem("warnedCloud")){const t=e?.find((e=>"cloud"===e.source));t&&(this.storage.setItem("warnedCloud","true"),D.a(`${this.name} is a cloud camera. Prebuffering maintains a persistent stream and will not enabled by default. You must enable the Prebuffer stream manually.`))}const s=this.mixinDeviceInterfaces.includes(S.ScryptedInterface.Battery);r.length||(this.online=!0);let n=0;const o=new Set(this.sessions.keys());o.delete(void 0),this.sessions.delete(void 0);for(const t of i){o.delete(t);let i=this.sessions.get(t);if(i)continue;const a=e?.find((e=>e.id===t));a?.prebuffer&&D.a(`Prebuffer is already available on ${this.name}. If this is a grouped device, disable the Rebroadcast extension.`);const c=a?.name,l=r.includes(t),d=s&&!a.allowBatteryPrebuffer||!l;i=new z(this,a,d),this.sessions.set(t,i),!s||a.allowBatteryPrebuffer?l?(async()=>{for(;this.sessions.get(t)===i&&!this.released;){i.ensurePrebufferSession();let e=!1;try{this.console.log("prebuffer session starting");const t=await i.parserSessionPromise;this.console.log("prebuffer session started"),n++,e=!0,this.online=!!n,await t.killed,this.console.error("prebuffer session ended")}catch(e){this.console.error("prebuffer session ended with error",e)}finally{e&&n--,e=!1,this.online=!!n}this.console.log("restarting prebuffer session in 5 seconds"),await new Promise((e=>setTimeout(e,5e3)))}this.console.log("exiting prebuffer session (released or restarted with new configuration)")})():this.console.log("stream",c,"will be rebroadcast on demand."):this.console.log("camera is battery powered, prebuffering and rebroadcasting will only work on demand.")}if(!this.sessions.has(void 0)){const t=this.streamSettings.storageSettings.values.defaultStream;let s=this.sessions.get(e?.find((e=>e.name===t))?.id);s||(s=this.sessions.get(e?.find((e=>e.id===r[0]))?.id)),s||(s=this.sessions.get(e?.find((e=>e.id===i?.[0]))?.id)),s?this.sessions.set(void 0,s):this.console.warn("Unable to find Default Stream?")}if(o.size){this.console.log("Removing sessions due to config change",[...o]);for(const e of o){const t=this.sessions.get(e);this.sessions.delete(e),t.release()}}}async getMixinSettings(){const e=[];e.push(...await this.streamSettings.storageSettings.getSettings());for(const t of new Set([...this.sessions.values()]))if(t)try{e.push(...await t.getMixinSettings())}catch(e){this.console.error("error in prebuffer session getMixinSettings",e)}return e}async putMixinSetting(e,t){if(this.streamSettings.storageSettings.settings[e]?await this.streamSettings.storageSettings.putSetting(e,t):this.storage.setItem(e,t?.toString()||""),"Transcoding"===this.streamSettings.storageSettings.settings[e]?.group)return;const r=this.sessions;this.sessions=new Map;for(const e of r.values())e?.parserSessionPromise?.then((e=>e.kill(new Error("rebroadcast settings changed"))));this.ensurePrebufferSessions()}getPrebufferedStreams(e){return this.streamSettings.getPrebufferedStreams(e)}async getVideoStreamOptions(){const e=await this.mixinDevice.getVideoStreamOptions()||[];let t=this.getPrebufferedStreams(e);const r=new Map;r.set("local",this.streamSettings.getDefaultStream(e)?.stream?.id),r.set("remote",this.streamSettings.getRemoteStream(e)?.stream?.id),r.set("medium-resolution",this.streamSettings.getRemoteRecordingStream(e)?.stream?.id),r.set("remote-recorder",this.streamSettings.getRemoteRecordingStream(e)?.stream?.id),r.set("local-recorder",this.streamSettings.getRecordingStream(e)?.stream?.id),r.set("low-resolution",this.streamSettings.getLowResolutionStream(e)?.stream?.id);for(const i of e){const e=this.sessions.get(i.id);if((e?.parserSession||t.includes(i))&&(i.prebuffer=1e4),e&&!i.video?.h264Info&&(i.video||={},i.video.h264Info=e.getLastH264Probe()),!i.destinations){i.destinations=[];for(const[e,t]of r.entries())t===i.id&&i.destinations.push(e)}}return e}async release(){this.settingsListener.removeListener(),this.online=!0,super.release(),this.console.log("prebuffer session releasing if started"),this.released=!0;for(const e of this.sessions.values())e?.release()}}class Q extends a.AutoenableMixinProvider{constructor(e){super(e),this.storageSettings=new y.StorageSettings(this,{}),this.transcodeStorageSettings=new y.StorageSettings(this,{remoteStreamingBitrate:{title:"Remote Streaming Bitrate",type:"number",defaultValue:1e6,description:"The bitrate to use when remote streaming. This setting will only be used when transcoding or adaptive bitrate is enabled on a camera.",onPut(){S.default.deviceManager.onDeviceEvent("transcode",S.ScryptedInterface.Settings,void 0)}},h264EncoderArguments:{title:"H264 Encoder Arguments",description:"FFmpeg arguments used to encode h264 video. This is not camera specific and is used to setup the hardware accelerated encoder on your Scrypted server. This setting will only be used when transcoding is enabled on a camera.",choices:Object.keys((0,c.getH264EncoderArgs)()),defaultValue:(0,c.getDebugModeH264EncoderArgs)().join(" "),combobox:!0,mapPut:(e,t)=>(0,c.getH264EncoderArgs)()[t]?.join(" ")||t||(0,c.getDebugModeH264EncoderArgs)().join(" "),onPut(){S.default.deviceManager.onDeviceEvent("transcode",S.ScryptedInterface.Settings,void 0)}}}),this.currentMixins=new Map,this.fromMimeType="x-scrypted/x-rfc4571",this.toMimeType=S.ScryptedMimeTypes.FFmpegInput,process.nextTick((()=>{for(const e of Object.keys(C.getSystemState())){const t=C.getDeviceById(e);if(t.mixins?.includes(this.id))try{t.getVideoStreamOptions()}catch(e){this.console.error("error triggering prebuffer",t.name,e)}}}));const t=function(){var e=new Date;return e.setHours(24),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e.getTime()-(new Date).getTime()}()+72e5;this.log.i(`Rebroadcaster scheduled for restart at 2AM: ${Math.round(t/1e3/60)} minutes`),setTimeout((()=>N.requestRestart()),t),process.nextTick((()=>{N.onDeviceDiscovered({nativeId:M.TRANSCODE_MIXIN_PROVIDER_NATIVE_ID,name:"Transcoding",interfaces:["SystemSettings",S.ScryptedInterface.Settings,S.ScryptedInterface.MixinProvider],type:S.ScryptedDeviceType.API})}))}async releaseDevice(e,t){}async getDevice(e){if(e===M.TRANSCODE_MIXIN_PROVIDER_NATIVE_ID)return new M.TranscodeMixinProvider(this)}getSettings(){return this.storageSettings.getSettings()}putSetting(e,t){return this.storageSettings.putSetting(e,t)}async convert(e,t,r){const i=JSON.parse(e.toString()),{url:s,sdp:n}=i,o=(0,m.parseSdp)(n),a=new Map;for(const e of o.msections)for(const t of e.payloadTypes)a.set(t,e.control);const c=new URL(s);if(!c.protocol.startsWith("tcp"))throw new Error("rfc4751 url must be tcp");const{clientPromise:l,url:d}=await(0,u.listenZeroSingleClient)(),f={url:d,inputArguments:["-rtsp_transport","tcp","-i",d.replace("tcp","rtsp")]};return l.then((async e=>{const t=new h.RtspServer(e,n);t.console=this.console,await t.handlePlayback();const r=w.default.connect(parseInt(c.port),c.hostname);for(e.on("close",(()=>{r.destroy()})),r.on("close",(()=>{e.destroy()}));;){const i=(await(0,p.readLength)(r,2)).readInt16BE(0),s=await(0,p.readLength)(r,i),n=127&s[1],o=a.get(n);if(!o)throw e.destroy(),r.destroy(),new Error("unknown payload type "+n);t.sendTrack(o,s,!1)}})),Buffer.from(JSON.stringify(f))}async shouldEnableMixin(e){return e.type===S.ScryptedDeviceType.Camera||e.type===S.ScryptedDeviceType.Doorbell}async canMixin(e,t){if(!t.includes(S.ScryptedInterface.VideoCamera))return null;return[S.ScryptedInterface.VideoCamera,S.ScryptedInterface.Settings,S.ScryptedInterface.Online,R.REBROADCAST_MIXIN_INTERFACE_TOKEN]}async getMixin(e,t,r){this.setHasEnabledMixin(r.id);let i=!1;try{const e=await C.getComponent("info"),t=await e.getVersion();i=E.default.gte(t,"0.2.5")}catch(e){}const{id:s}=r;if(!i||!S.default.fork||"string"!=typeof r.id){const i=await J((async()=>this.transcodeStorageSettings.values),e,t,r);return this.currentMixins.set(i,{worker:void 0,id:s}),i}{const i=S.default.fork(),{worker:n}=i;try{const o=await i.result,a=await o.newPrebufferMixin((async()=>this.transcodeStorageSettings.values),e,t,r);return this.currentMixins.set(a,{worker:n,id:s}),a}catch(e){throw e}}}async releaseMixin(e,t){const r=this.currentMixins.get(t)?.worker;this.currentMixins.delete(t),await t.release().catch((()=>{})),await(0,g.sleep)(1e3),r?.terminate()}}async function J(e,t,r,i){return new Z(e,{mixinDevice:t,mixinDeviceState:i,mixinProviderNativeId:void 0,mixinDeviceInterfaces:r,group:"Streams",groupKey:"prebuffer"})}t.RebroadcastPlugin=Q;class ee{constructor(){this.newPrebufferMixin=J}}t.fork=async function(){return new ee},t.default=Q},1514:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REBROADCAST_MIXIN_INTERFACE_TOKEN=void 0,t.REBROADCAST_MIXIN_INTERFACE_TOKEN="mixin:@scrypted/prebuffer-mixin"},8339:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.startRFC4571Parser=t.connectRFC4571Parser=t.negotiateMediaStream=void 0;const s=r(4942),n=r(5958),o=r(6521),a=r(7030),c=r(1853),l=r(3859),d=i(r(1808)),u=r(2781),p=r(7090);function h(e,t,r,i,n){const o=(0,c.parseSdp)(e),a=(0,s.cloneDeep)(t)||{id:void 0,name:void 0};if(void 0===a.video&&(a.video={}),null===n?.video&&(a.video=null),a.video&&(a.video.codec=r),n?.audio?.codec&&n?.audio?.codec!==i){if(o.msections.find((e=>"audio"===e.type&&e.codec===n?.audio?.codec)))return a.audio={codec:n?.audio?.codec},a}return a.audio=a?.audio?.codec===i?t?.audio:{codec:i},a}t.negotiateMediaStream=h,t.connectRFC4571Parser=function(e){const t=new URL(e);if(!t.protocol.startsWith("tcp"))throw new Error("rfc4751 url must be tcp");return d.default.connect(parseInt(t.port),t.hostname)},t.startRFC4571Parser=function(e,t,r,i,s){let d=!0;const m=new u.EventEmitter;m.on("error",(t=>e.error("rebroadcast error",t)));const f=(0,c.parseSdp)(r),g=f.msections.find((e=>"audio"===e.type)),v=f.msections.find((e=>"video"===e.type)),S=g?.payloadTypes?.[0],y=v?.payloadTypes?.[0],_=g?.codec,b=v.codec;let w;const E=new Promise((e=>{w=e})),P=e=>{d&&(m.emit("killed"),m.emit("error",e||new Error("killed"))),d=!1,w(),t.destroy()};t.on("close",(()=>{P(new Error("rfc4751 socket closed"))})),t.on("error",(e=>{P(e)}));const{resetActivityTimer:T}=(0,n.setupActivityTimer)("rtsp",P,m,s?.timeout);let R;const I=v?.fmtp?.[0]?.parameters?.["sprop-parameter-sets"],O=I?.split(",")?.[0];if(O)try{const t=Buffer.from(O,"base64"),r=(0,l.parse)(t);R=(0,p.getSpsResolution)(r),e.log("parsed sdp sps",r)}catch(t){e.warn("sdp sps parsing failed")}return{start:()=>{(0,o.read16BELengthLoop)(t,{headerLength:2,skipHeader:void 0,callback:(t,r)=>{let i;const s=127&r[1],n=Buffer.alloc(2);n[0]=a.RTSP_FRAME_MAGIC,s===S?n[1]=0:s===y&&(n[1]=2),t=Buffer.concat([n,t]),s===S?i=_:s===y&&(i=b);const o={chunks:[t,r],type:i};if(!R){const t=(0,a.findH264NaluType)(o,a.H264_NAL_TYPE_SPS);if(t)try{const r=(0,l.parse)(t);R=(0,p.getSpsResolution)(r),e.log(R),e.log("parsed bitstream sps",r)}catch(t){e.warn("sps parsing failed"),R={width:NaN,height:NaN}}}m.emit("rtsp",o),T()}}).catch((e=>{throw e})).finally((()=>{P(new Error("parser exited"))}))},sdp:Promise.resolve([Buffer.from(r)]),inputAudioCodec:_,inputVideoCodec:b,get inputVideoResolution(){return R},get isActive(){return d},kill(e){P(e)},killed:E,resetActivityTimer:T,negotiateMediaStream:e=>h(r,i,b,_,e),emit(e,t){return m.emit(e,t),this},on(e,t){return m.on(e,t),this},once(e,t){return m.once(e,t),this},removeListener(e,t){return m.removeListener(e,t),this}}}},7662:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.startRtspSession=void 0;const i=r(5958),s=r(400),n=r(7030),o=r(1853),a=r(3859),c=r(2781),l=r(8339),d=r(7090);t.startRtspSession=async function(e,t,r,u){let p=!0;const h=new c.EventEmitter;h.on("error",(t=>e.error("rebroadcast error",t)));let m=[];const f=new n.RtspClient(t);f.console=e,f.requestTimeout=u.rtspRequestTimeout;const g=()=>{for(const e of m)(0,s.closeQuiet)(e);f.safeTeardown()};let v;const S=new Promise((e=>{v=e})),y=e=>{p&&(h.emit("killed"),h.emit("error",e||new Error("killed"))),p=!1,v(),g()};f.client.on("close",(()=>{y(new Error("rtsp socket closed"))})),f.client.on("error",(e=>{y(e)}));const{resetActivityTimer:_}=(0,i.setupActivityTimer)("rtsp",y,h,u?.rtspRequestTimeout);try{await f.options();const t=await f.describe(),i=t.headers["content-base"];if(i){const e=new URL(i,f.url),t=new URL(f.url);for(const r of t.searchParams)e.searchParams.append(r[0],r[1]);e.username=t.username,e.password=t.password,f.url=e.toString()}let s=t.body.toString().trim();e.log("sdp",s);const c=(0,o.parseSdp)(s);let m=0;const g={};let v;const{useUdp:b}=u,w=e=>{if(b&&e.session&&!v){const t=(0,n.parseSemicolonDelimited)(e.session);v=parseInt(t.timeout)}};let E;b||(E={interleaved:new Map});const P=async(e,t)=>{let r;if(b){const i=m,s={path:e,type:"udp",onRtp:(e,r)=>{const s=Buffer.alloc(4);s.writeUInt8(n.RTSP_FRAME_MAGIC,0),s.writeUInt8(i,1),s.writeUInt16BE(r.length,2);const o={chunks:[s,r],type:t};h.emit("rtsp",o),_?.()}},o=await f.setup(s);r=s.dgram,w(o.headers);const a=Buffer.alloc(1),c=o.headers.transport.match(/.*?server_port=([0-9]+)-([0-9]+)/),[l,d,u]=c,p=parseInt(d);if(p){const{hostname:e}=new URL(f.url);r.send(a,p,e)}g[m]=t}else{const r=await f.setup({path:e,type:"tcp",port:m,onRtp:(e,r)=>{const i={chunks:[e,r],type:t};h.emit("rtsp",i),_?.()}}),i=r.interleaved?r.interleaved.begin:m;g[i]=t,E.interleaved.set(t,i)}m+=2};let T=!1;c.msections=c.msections.filter((t=>{if("video"===t.type){if(T)return e.warn("additional video section found. skipping."),!1;T=!0}else{if("audio"!==t.type)return e.warn("unknown section",t.type),!1;if(u.audioSoftMuted)return!1}return!0}));for(const e of c.msections)await P(e.control,e.codec);s=[...c.header.lines,...c.msections.map((e=>e.lines)).flat()].join("\r\n");const R=async()=>{try{await f.play(),f.console=void 0,await f.readLoop()}catch(e){y(e)}finally{y(new Error("rtsp read loop exited"))}};return(()=>{const t=c.msections.find((e=>"audio"===e.type)),i=c.msections.find((e=>"video"===e.type));if(!i)throw new Error("SDP does not contain a video section!");const o=t?.codec,u=i.codec;let m;const f=Date.now(),g=t=>{Date.now()-f>6e3&&h.removeListener("rtsp",g);const r=(0,n.findH264NaluType)(t,n.H264_NAL_TYPE_SPS);if(r){try{const t=(0,a.parse)(r);m=(0,d.getSpsResolution)(t),e.log("parsed bitstream sps",m)}catch(t){e.warn("sps parsing failed"),m={width:NaN,height:NaN}}h.removeListener("rtsp",g)}};m||h.on("rtsp",g);const v=i?.fmtp?.[0]?.parameters?.["sprop-parameter-sets"],b=v?.split(",")?.[0];if(b)try{const t=Buffer.from(b,"base64"),r=(0,a.parse)(t);m=(0,d.getSpsResolution)(r),e.log("parsed sdp sps",m)}catch(t){e.warn("sdp sps parsing failed")}return{parserSpecific:E,start:R,sdp:Promise.resolve([Buffer.from(s)]),inputAudioCodec:o,inputVideoCodec:u,get inputVideoResolution(){return m},get isActive(){return p},kill(e){y(e)},killed:S,resetActivityTimer:_,negotiateMediaStream:e=>(0,l.negotiateMediaStream)(s,r,u,o,e),emit(e,t){return h.emit(e,t),this},on(e,t){return h.on(e,t),this},once(e,t){return h.once(e,t),this},removeListener(e,t){return h.removeListener(e,t),this}}})()}catch(e){throw g(),e}}},7090:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getSpsResolution=void 0,t.getSpsResolution=function(e){let t,r;0==e.chroma_format_idc&&0==e.color_plane_flag?t=r=0:1==e.chroma_format_idc&&0==e.color_plane_flag?t=r=2:2==e.chroma_format_idc&&0==e.color_plane_flag?(t=2,r=1):3==e.chroma_format_idc&&(0==e.color_plane_flag?t=r=1:1==e.color_plane_flag&&(t=r=0));let i=e.pic_width_in_mbs,s=e.pic_height_in_map_units,n=(2-e.frame_mbs_only_flag)*s,o=0,a=0,c=0,l=0;return e.frame_cropping_flag&&(o=e.frame_cropping.left,a=e.frame_cropping.right,c=e.frame_cropping.top,l=e.frame_cropping.bottom),{width:16*i-t*(o+a),height:16*n-r*(2-e.frame_mbs_only_flag)*(c+l)}}},2977:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createStreamSettings=void 0;const i=r(7488),s=r(8202),n=r(1459);t.createStreamSettings=function(e){const t="Manage",r={defaultStream:{subgroup:t,title:"Local Stream",description:"The media stream to use when streaming on your local network. This stream should be prebuffered. Recommended resolution: 1920x1080 to 4K.",hide:!0,prefersPrebuffer:!1,preferredResolution:8294400},remoteStream:{subgroup:t,title:"Remote (Medium Resolution) Stream",description:"The media stream to use when streaming from outside your local network. Selecting a low birate stream is recommended. Recommended resolution: 1280x720.",hide:!0,prefersPrebuffer:!1,preferredResolution:921600},lowResolutionStream:{subgroup:t,title:"Low Resolution Stream",description:"The media stream to use for low resolution output, such as Apple Watch and Video Analysis. Recommended resolution: 480x360.",hide:!0,prefersPrebuffer:!1,preferredResolution:172800},recordingStream:{subgroup:t,title:"Local Recording Stream",description:"The media stream to use when recording to local storage such as an NVR. Recommended resolution: 1920x1080 to 4K.",hide:!0,prefersPrebuffer:!1,preferredResolution:8294400},remoteRecordingStream:{subgroup:t,title:"Remote Recording Stream",description:"The media stream to use when recording to cloud storage such as HomeKit Secure Video clips in iCloud. This stream should be prebuffered. Recommended resolution: 1280x720.",hide:!0,prefersPrebuffer:!0,preferredResolution:3686400}},o=new s.StorageSettings(e,{enabledStreams:{subgroup:t,title:"Prebuffered Streams",description:"Prebuffering maintains an active connection to the stream and improves load times. Prebuffer also retains the recent video for capturing motion events with HomeKit Secure video. Enabling Prebuffer is not recommended on Cloud cameras.",multiple:!0,hide:!1},...r,rebroadcastPort:{subgroup:t,title:"Rebroadcast Port",description:"The port of the RTSP server that will rebroadcast your streams.",type:"number",hide:!1},transcodeStreams:{group:"Transcoding",title:"Transcode Streams",description:"The media streams to transcode. Transcoding audio and video is not recommended and should only be used when necessary. The Rebroadcast Plugin manages the system-wide Transcode settings. See the Rebroadcast Readme for optimal configuration.",multiple:!0,choices:Object.values(r).map((e=>e.title)),hide:!0},videoDecoderArguments:{group:"Transcoding",title:"Video Decoder Arguments",description:"FFmpeg arguments used to decode input video when transcoding a stream.",placeholder:"-hwaccel auto",choices:Object.keys((0,i.getH264DecoderArgs)()),combobox:!0,mapPut:(e,t)=>(0,i.getH264DecoderArgs)()[t]?.join(" ")||t||"",hide:!0},videoFilterArguments:{group:"Transcoding",title:"Video Filter Arguments",description:"FFmpeg arguments used to filter input video when transcoding a stream. This can be used to crops, scale, rotates, etc.",placeholder:"transpose=1",hide:!0},missingCodecParameters:{group:"Transcoding",title:"Out of Band Codec Parameters",description:"Some cameras do not include H264 codec parameters in the stream and this causes live streaming to always fail (but recordings may be working). This is a inexpensive video filter and does not perform a transcode. Enable this setting only as necessary.",type:"boolean",hide:!0}});function a(e){if(!e)return;const t=l(o.keys.defaultStream,e),r=l(o.keys.remoteRecordingStream,e);return t?.stream&&"cloud"!==t.stream.source?t.stream.id===r.stream.id?[t.stream]:[t.stream,r.stream]:[]}function c(e,t){return function(e,t){if(!e)return;let r,i;for(const s of e){const e=Math.abs(s.video?.width*s.video?.height-t);(!r||e<i)&&(r=s,i=e,Number.isNaN(i)&&(i=Number.MAX_SAFE_INTEGER))}return r}(t,e.preferredResolution)}function l(e,t){const i=o.settings[e],s=o.values[e];let n="Default"===s,a=t?.find((e=>e.name===s));return!n&&a||(n=!0,a=c(i,t)),{title:r[e].title,isDefault:n,stream:a}}function d(e,t){const r=["Default",...t.map((e=>e.name))],i=c(e,t).name;return{defaultValue:"Default",description:e.description+` The default for this stream is ${i}.`,choices:r,hide:!1}}return o.options={onGet:async()=>{let t;const i=e.mixins?.includes((0,n.getTranscodeMixinProviderId)())?{hide:!1}:{},s={transcodeStreams:i,missingCodecParameters:i,videoDecoderArguments:i,videoFilterArguments:i};try{const i=await e.mixinDevice.getVideoStreamOptions();return t={defaultValue:a(i)?.map((e=>e.name||e.id)),choices:i.map(((e,t)=>e.name||e.id)),hide:!1},i?.length>1?{enabledStreams:t,defaultStream:d(r.defaultStream,i),remoteStream:d(r.remoteStream,i),lowResolutionStream:d(r.lowResolutionStream,i),recordingStream:d(r.recordingStream,i),remoteRecordingStream:d(r.remoteRecordingStream,i),...s}:{enabledStreams:t,...s}}catch(t){e.console.error("error retrieving getVideoStreamOptions",t)}return{...s}}},{getDefaultPrebufferedStreams:a,getPrebufferedStreams:function(e){if(e)return o.hasValue.enabledStreams?e.filter((e=>o.values.enabledStreams.includes(e.name))):a(e)},getDefaultStream:e=>l(o.keys.defaultStream,e),getRemoteStream:e=>l(o.keys.remoteStream,e),getLowResolutionStream:e=>l(o.keys.lowResolutionStream,e),getRecordingStream:e=>l(o.keys.recordingStream,e),getRemoteRecordingStream:e=>l(o.keys.remoteRecordingStream,e),storageSettings:o}}},1459:function(e,t,r){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&i(t,e,r);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.TranscodeMixinProvider=t.getTranscodeMixinProviderId=t.TRANSCODE_MIXIN_PROVIDER_NATIVE_ID=void 0;const o=n(r(7954)),a=r(1514),{deviceManager:c}=o.default;t.TRANSCODE_MIXIN_PROVIDER_NATIVE_ID="transcode",t.getTranscodeMixinProviderId=function(){if(!c.getNativeIds().includes(t.TRANSCODE_MIXIN_PROVIDER_NATIVE_ID))return;return c.getDeviceState(t.TRANSCODE_MIXIN_PROVIDER_NATIVE_ID)?.id};class l extends o.ScryptedDeviceBase{constructor(e){super(t.TRANSCODE_MIXIN_PROVIDER_NATIVE_ID),this.plugin=e}getSettings(){return this.plugin.transcodeStorageSettings.getSettings()}putSetting(e,t){return this.plugin.transcodeStorageSettings.putSetting(e,t)}async canMixin(e,t){if(t.includes(a.REBROADCAST_MIXIN_INTERFACE_TOKEN))return[o.ScryptedInterface.Settings]}invalidateSettings(e){process.nextTick((async()=>{for(const[t,r]of this.plugin.currentMixins.entries())r.id===e&&t?.onDeviceEvent(o.ScryptedInterface.Settings,void 0)}))}async getMixin(e,t,r){return this.invalidateSettings(r.id),e}async releaseMixin(e,t){this.invalidateSettings(e)}}t.TranscodeMixinProvider=l},7189:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.listenZeroSingleClient=t.listenZero=t.ListenZeroSingleClientTimeoutError=void 0;const s=r(2361),n=i(r(1808));class o extends Error{constructor(){super("timeout waiting for client")}}async function a(e,t){return e.listen(0,t),await(0,s.once)(e,"listening"),e.address().port}t.ListenZeroSingleClientTimeoutError=o,t.listenZero=a,t.listenZeroSingleClient=async function(e){const t=new n.default.Server,r=await a(t,e),i=new Promise(((e,r)=>{const i=setTimeout((()=>{t.close(),r(new o)}),3e4);t.on("connection",(r=>{t.close(),clearTimeout(i),e(r)}))}));i.catch((()=>{}));let s=e;return s&&"0.0.0.0"!==s||(s="127.0.0.1"),{server:t,url:`tcp://${s}:${r}`,host:s,port:r,clientPromise:i}}},1795:function(e,t,r){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.safePrintFFmpegArguments=t.ffmpegLogInitialOutput=t.safeKillFFmpeg=void 0;const s=i(r(7282)),n=["decode_slice_header error","no frame!","non-existing PPS"];t.safeKillFFmpeg=function(e){if(e){try{e.stdin.write("q\n")}catch(e){}setTimeout((()=>{e.kill(),setTimeout((()=>{e.kill("SIGKILL")}),2e3)}),2e3)}},t.ffmpegLogInitialOutput=function(e,t,r,i){if(!e)return;const o=!!s.default.env.SCRYPTED_FFMPEG_NOISY||!!i?.getItem("SCRYPTED_FFMPEG_NOISY");function a(e){const i=s=>{const a=s.toString();for(const e of n)if(-1!==a.indexOf(e))return;if(!(o||r||-1===a.indexOf("frame=")&&-1===a.indexOf("size=")))return e(a),e("video/audio detected, discarding further input"),t.stdout.removeListener("data",i),void t.stderr.removeListener("data",i);e(a)};return i}t.stdout?.on("data",a(e.log)),t.stderr?.on("data",a(e.error)),t.on("exit",(()=>e.log("ffmpeg exited")))},t.safePrintFFmpegArguments=function(e,t){if(!e)return;const r=[];let i=!1;for(const e of t){try{if(i){const t=new URL(e);r.push(`${t.protocol}[REDACTED]`)}else r.push(e)}catch(t){r.push(e)}i="-i"===e}e.log(r.join(" "))}},9413:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sleep=void 0,t.sleep=async function(e){await new Promise((t=>setTimeout(t,e)))}},1158:e=>{const t=require("realfs");e.exports=t},2081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},1891:e=>{"use strict";e.exports=require("dgram")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},1808:e=>{"use strict";e.exports=require("net")},2037:e=>{"use strict";e.exports=require("os")},7282:e=>{"use strict";e.exports=require("process")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},7310:e=>{"use strict";e.exports=require("url")},8257:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>m});var i=r(2037);function s(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function n(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function o(e){var t="function"==typeof Map?new Map:void 0;return o=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return a(e,arguments,d(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),l(i,e)},o(e)}function a(e,t,r){return a=c()?Reflect.construct:function(e,t,r){var i=[null];i.push.apply(i,t);var s=new(Function.bind.apply(e,i));return r&&l(s,r.prototype),s},a.apply(null,arguments)}function c(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}let u=function(e){function t(e,r,...i){var s,o,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e instanceof Array||(i=(void 0===r?[]:[r]).concat(i),r=e,e=[]),o=this,(s=!(a=d(t).call(this,r))||"object"!=typeof a&&"function"!=typeof a?n(o):a).code=r||"E_UNEXPECTED",s.params=i,s.wrappedErrors=e,s.name=s.toString(),Error.captureStackTrace&&Error.captureStackTrace(n(s),s.constructor),s}var r,o,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,e),r=t,(o=[{key:"toString",value:function(){return(this.wrappedErrors.length?this.wrappedErrors[this.wrappedErrors.length-1].stack+i.EOL:"")+this.constructor.name+": "+this.code+" ("+this.params.join(", ")+")"}}])&&s(r.prototype,o),a&&s(r,a),t}(o(Error));function p(e){return e instanceof u||e.constructor&&e.constructor.name&&e.constructor.name.endsWith("Error")&&"string"==typeof e.code&&h(e.code)&&e.params&&e.params instanceof Array}function h(e){return/^([A-Z0-9_]+)$/.test(e)}u.wrap=function(e,t,...r){let i=null;const s=h(e.message),n=(e.wrappedErrors||[]).concat(e);return t||(t=s?e.message:"E_UNEXPECTED"),e.message&&!s&&r.push(e.message),i=new u(n,t,...r),i},u.cast=function(e,...t){return p(e)?e:u.wrap.apply(u,[e].concat(t))},u.bump=function(e,...t){return p(e)?u.wrap.apply(u,[e,e.code].concat(e.params)):u.wrap.apply(u,[e].concat(t))};const m=u}},t={};function r(i){var s=t[i];if(void 0!==s)return s.exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,r),n.exports}r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i=r(6360),s=exports="undefined"==typeof exports?{}:exports;for(var n in i)s[n]=i[n];i.__esModule&&Object.defineProperty(s,"__esModule",{value:!0})})();
//# sourceMappingURL=main.nodejs.js.map